#################### 1. Preparation ####################
############### 1.1 Install Packages ###############
# Install packages if they are not already installed
if (!require("shiny")) install.packages("shiny")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("readxl")) install.packages("readxl")
if (!require("dplyr")) install.packages("dplyr")
if (!require("shinythemes")) install.packages("shinythemes")
if (!require("shinyBS")) install.packages("shinyBS")
if (!require("Hmisc")) install.packages("Hmisc")
if (!require("ggsci")) install.packages("ggsci")
if (!require("ggthemes")) install.packages("ggthemes")
if (!require("rclipboard")) install.packages("rclipboard")
if (!require("sortable")) install.packages("sortable")












############### 1.2 Load Packages ###############
# Load Packages
library(shiny)
library(ggplot2)
library(readxl)
library(dplyr)
library(shinythemes)
library(shinyBS)
library(Hmisc)
library(ggsci)
library(ggthemes)
library(rclipboard)
library(sortable)












############### 1.3 Define Panel-Function ###############
# BSCollapse-Function is set using an arrow-down icon
BSCollapseArrow <- function(text, icon_class = "glyphicon-menu-down") {
  HTML(sprintf(
    '<div class="panel-title-container">
       <i class="glyphicon %s"></i>
       <span>%s</span>
     </div>', 
    icon_class, text
  ))
}












############### 1.4 Define Color Validation Function ###############
is_valid_color <- function(color) {
  # empty colors are not invalid
  if (is.null(color) || color == "") return(FALSE)
  tryCatch({
    # Check if valid color
    col2rgb(color)
    TRUE
  }, error = function(e) FALSE)
}



















#################### 2. UI ####################
ui <- fluidPage(
  ############### 2.1 General Settings ###############
  # Define Theme
  theme = shinytheme("cerulean"),
  
  # Define custom CSS
  tags$head(
    tags$style(HTML("
    
    /* Border of Panels */
    .panel{
    border: 2px solid #dddddd;
    }
    
    /* Background Color of Panels */
    .panel-body {
    background-color: #f5f5f5 !important;
    }

    /* Axis Settings */
    .collapse_panel-settings .col-sm-6 {
    border: 1px solid #ddd;
    padding: 10px;
    margin-bottom: 10px;
    }
    
    /* Font Color of Heading */
    h1, h2, h3, h4, h5, h6 {
    color: #000000 !important;
    }
    
    
    /* Define Buttons */
    .custom-btn {
    font-size: 18px;
    padding: 5px 15px;
    margin: 20px 5px;
    color: black;
    border: 5px solid #bbb;
    border-radius: 5px;
    outline: none;
    border-style: double;
    }
    
    /* Define Buttons when Hovered */
    .custom-btn:hover {
    background-color: #f0f0f0;
    }

    /* Define Buttons when Active */
    .active-btn {
    background-color: #e0e0e0;
    color: black;
    background-image: none;
    }


    /* Define Button for Plots */
    .plot-btn {
    font-size: 30px;
    padding: 5px 30px;
    margin: 20px 10px;
    color: black;
    border: 5px solid #bbb;
    border-radius: 5px;
    outline: none;
    border-style: double;
    }


    /* Define Plot-Buttons when Selected/active */
    .active-plot {
    background-color: #e0e0e0;
    color: black;
    background-image: none;
    }    
    
  "))
  ),
  
  
  # Define a fluid Row
  fluidRow(
    # Set a Column
    column(3, 
           # Set the title panel
           titlePanel(title = span(img(src = "logo.png", height = 50), HTML('<span style="font-size: 1.95em;">ggpilot</span>')), windowTitle = "ggpilot")),
    # Set a 
    column(9, align = "center", 
           style = "margin-top: 15px;",
           tags$head(
             tags$style(HTML("
          "))
           ),
           tags$script(HTML("
            Shiny.addCustomMessageHandler('setActiveButton', function(btnId) {
              $('.custom-btn').removeClass('active-btn');
              $('#' + btnId).addClass('active-btn');
            });
         ")),
           actionButton("btn_data", label = HTML('<i class="glyphicon glyphicon-folder-open"></i> Daten'), class = "custom-btn"),
           actionButton("btn_plottype", label = HTML('<i class="glyphicon glyphicon-stats"></i> Plot-Typ'), class = "custom-btn"),
           actionButton("btn_variables", label = HTML('<i class="glyphicon glyphicon-tasks"></i> Variablen'), class = "custom-btn"),
           actionButton("btn_plot_options", label = HTML('<i class="glyphicon glyphicon-wrench"></i> Plot Optionen'), class = "custom-btn"),
           actionButton("btn_text", label = HTML('<i class="glyphicon glyphicon-font"></i> Text'), class = "custom-btn"),
           actionButton("btn_layout", label = HTML('<i class="glyphicon glyphicon-adjust"></i> Layout'), class = "custom-btn"),
           actionButton("btn_download", label = HTML('<i class="glyphicon glyphicon-download"></i> Download'), class = "custom-btn"),
    )
  ),
  
  
  # Hidden Input for the Active Tab
  tags$div(
    textInput("activeTab", label = NULL, value = "data"),
    # Set the Input to be hidden
    style = "display: none;"
  ),  

  # Define Sidebar-Layout
  sidebarLayout(
    
    # Define Panel in Sidebar with width of 3
    sidebarPanel(width = 4,
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 
                 ############### 2.2 Input Fields ###############
                 # Define Conditional-Panel for when data tab is selected
                 conditionalPanel(condition = "input.activeTab == 'data'",
                                  ########## 2.2.1 Select Data ########## 
                                  # Add Button for File Input
                                  fileInput("file", "Datensatz auswählen",
                                            buttonLabel = "Durchsuchen", placeholder = "Keine Datei ausgewählt", 
                                            accept = c(".csv", ".xlsx", ".rds", ".RData"))),
                 
                 
                 
                 
                 
                 ########## 2.2.2 Select Plot-Type ##########
                 # Define HTML-Script for handling Plot-Types
                 tags$script(HTML("
                                  Shiny.addCustomMessageHandler('setActivePlot', function(btnId) {
                                  $('.plot-btn').removeClass('active-plot');
                                  $('#' + btnId).addClass('active-plot');
                                  });
                                  ")),                 
                 
                 # Define Conditional-Panel for when plottype tab is selected
                 conditionalPanel(condition = "input.activeTab == 'plottype'",
                                  actionButton("plot_bar", label = HTML('<img src="Icon_Bar.png" height="100px" style="horizontal-align: middle;"> <br> Balken'), class = "plot-btn"),
                                  actionButton("plot_line", label = HTML('<img src="Icon_Line.png" height="100px" style="horizontal-align: middle;"> <br> Linien'), class = "plot-btn"),
                                  actionButton("plot_box", label = HTML('<img src="Icon_Box.png" height="100px" style="horizontal-align: middle;"> <br> Boxplot'), class = "plot-btn"),
                                  actionButton("plot_scatter", label = HTML('<img src="Icon_Scatter.png" height="100px" style="horizontal-align: middle;"> <br> Scatter'), class = "plot-btn")
                                  ),
                 
                 
                 
                 
                 
                 ########## 2.2.2 Select Variables ##########
                 # Define Conditional-Panel for when Variables tab is selected
                 conditionalPanel(condition = "input.activeTab == 'variables'",
                                  # Set title
                                  h3("X-Achsen-Variable"),
                                  # X-Axis Variable
                                  selectInput("x_var", NULL, choices = c(""), selected = ""),
                                  # Create a conditionl-panel for when a variable is selected
                                  conditionalPanel(condition = "output.is_numeric_x == false",
                                                   # Create a Layout for CollapsePanels
                                                   bsCollapse(id = "collapseExample", multiple = FALSE, open = NULL,
                                                              
                                                              # Create a Collapse-Panel for Theme-Settings
                                                              bsCollapsePanel(
                                                                # Define Title of Collapse-Panel
                                                                title = BSCollapseArrow("Reihenfolge der Stufen anpassen"),
                                                                # Placeholder for the ranking-UI
                                                                uiOutput("x_factor_rank_list")
                                                              )
                                                   )
                                  ),
                                  # Set title
                                  h3("Y-Achsen-Variable"),
                                  # Y-Axis Variable
                                  selectInput("y_var", NULL, choices = c(""), selected = ""),
                                  # Create a conditionl-panel for when a variable is selected
                                  conditionalPanel(condition = "output.is_numeric_y == false",
                                                   
                                                   # Create a Layout for CollapsePanels
                                                   bsCollapse(id = "collapseExample", multiple = FALSE, open = NULL,
                                                              
                                                              # Create a Collapse-Panel for Theme-Settings
                                                              bsCollapsePanel(
                                                                # Define Title of Collapse-Panel
                                                                title = BSCollapseArrow("Reihenfolge der Stufen anpassen"),
                                                                # Placeholder for the ranking-UI
                                                                uiOutput("y_factor_rank_list")
                                                              )
                                                   )
                                  ),
                                  # Set title
                                  h3("Gruppierungs-Variable"),
                                  # Grouping Variable
                                  selectInput("group_var", NULL, choices = c(""), selected = ""),
                                  # Create a conditionl-panel for when a variable is selected
                                  conditionalPanel(condition =  "output.is_numeric_group == false",
                                                   # Create a Layout for CollapsePanels
                                                   bsCollapse(id = "collapseExample", multiple = FALSE, open = NULL,
                                                              # Create a Collapse-Panel for Theme-Settings
                                                              bsCollapsePanel(
                                                                # Define Title of Collapse-Panel
                                                                title = BSCollapseArrow("Reihenfolge der Stufen anpassen"),
                                                                # Placeholder for the ranking-UI
                                                                uiOutput("group_factor_rank_list")
                                                              )
                                                   )
                                  ),
                                  # Set title
                                  h3("Variable für Spalten-Facettierung"),
                                  # Facet Grid - Columns
                                  selectInput("grid_col_var", NULL, choices = c(""), selected = ""),
                                  # Create a conditionl-panel for when a variable is selected
                                  conditionalPanel(condition =  "output.is_numeric_col == false",
                                                   # Create a Layout for CollapsePanels
                                                   bsCollapse(id = "collapseExample", multiple = FALSE, open = NULL,
                                                              
                                                              # Create a Collapse-Panel for Theme-Settings
                                                              bsCollapsePanel(
                                                                # Define Title of Collapse-Panel
                                                                title = BSCollapseArrow("Reihenfolge der Stufen anpassen"),
                                                                # Placeholder for the ranking-UI
                                                                uiOutput("grid_col_factor_rank_list")
                                                                )
                                                              )
                                  ),
                                  # Set title
                                  h3("Variable für Zeilen-Facettierung"),
                                  # Facet Grid - Rows
                                  selectInput("grid_row_var", NULL, choices = c(""), selected = ""),
                                  # Create a conditionl-panel for when a variable is selected
                                  conditionalPanel(condition =  "output.is_numeric_row == false",
                                                   # Create a Layout for CollapsePanels
                                                   bsCollapse(id = "collapseExample", multiple = FALSE, open = NULL,
                                                              # Create a Collapse-Panel for Theme-Settings
                                                              bsCollapsePanel(
                                                                # Define Title of Collapse-Panel
                                                                title = BSCollapseArrow("Reihenfolge der Stufen anpassen"),
                                                                # Placeholder for the ranking-UI
                                                                uiOutput("grid_row_factor_rank_list")
                                                                )
                                                              )
                                                   )
                                  ),
                 
                 
                 
                 
                 
                 ########## 2.2.3 Plot Options ##########
                 # Define Conditional-Panel for when Plot-Options tab is selected
                 conditionalPanel(condition = "input.activeTab == 'plot_options'",
                                  # Create a Layout for CollapsePanels
                                  bsCollapse(id = "collapseExample", multiple = FALSE, open = NULL,
                                             
                                             # Create a Collapse-Panel for Theme-Settings
                                             bsCollapsePanel(
                                               # Define Title of Collapse-Panel
                                               title = BSCollapseArrow("Theme"),
                                               # Define CSS Settings
                                               div(class = ".collapse_panel-settings",
                                                   # Create Input-Options for themes
                                                   selectInput(inputId = "plot_theme", label = "", 
                                                               choices = c("Bw", "Classic", "Gray", "Linedraw", "Light", "Dark", 
                                                                           "Minimal", "Void", "Calc", "the Economist", 
                                                                           "the Economist White", "Excel", "Few", "FiveThirtyEight", 
                                                                           "Google Docs", "Highcharts JS", "Inversed Gray", 
                                                                           "Solarized", "Solarized 2", "Solid", "Stata", "Tufte", 
                                                                           "Wall Street Journal"),
                                                               selected = "Gray")
                                               )
                                             ),
                                             
                                             # Create a Collapse-Panel for Plot-Size
                                             bsCollapsePanel(
                                               # Define Title of Collapse-Panel
                                               title = BSCollapseArrow("Plot-Grösse"),
                                               # Define CSS Settings
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          # Define Plot-Width
                                                          numericInput("plot_width_px", "Breite (in Pixel):", value = 800, min = 100),
                                                   ),
                                                   column(6,
                                                          # Define Plot-Height
                                                          numericInput("plot_height_px", "Höhe (in Pixel):", value = 600, min = 100),
                                                   )
                                               )
                                             ),
                                             
                                             
                                             # Create a Collapse-Panel for Axis-Range
                                             bsCollapsePanel(
                                               # Define Title of Collapse-Panel
                                               title = BSCollapseArrow("Achsen-Range definieren"),
                                               # Define CSS Settings
                                               div(class = ".collapse_panel-settings",
                                                   # Set a HTML header for the Y-Axis Range Text
                                                   HTML('<label class="control-label">X-Achse</label>'),
                                                   # Define the min and max value next to each other
                                                   div(
                                                     # Define style
                                                     style = "display: flex; justify-content: space-between; gap: 10px;",
                                                     div(
                                                       style = "flex: 1;",
                                                       # Numeric Input field for the minimal X-Axis value
                                                       numericInput(inputId = "x_axis_min", label = HTML('<span style="font-weight: normal;">Min</span>'), step = 0.1, value = "")
                                                     ),
                                                     div(
                                                       style = "flex: 1;",
                                                       # Numeric Input field for the max X-Axis value
                                                       numericInput(inputId = "x_axis_max", label = HTML('<span style="font-weight: normal;">Max</span>'), step = 0.1, value = "")
                                                     )
                                                   ),
                                                   
                                                   # Set a HTML header for the X-Axis Range Text
                                                   HTML('<label class="control-label">Y-Achse</label>'),
                                                   
                                                   # Define the min and max value next to each other
                                                   div(
                                                     # Define style
                                                     style = "display: flex; justify-content: space-between; gap: 10px;",
                                                     div(
                                                       style = "flex: 1;",
                                                       # Numeric Input field for the minimal Y-Axis value
                                                       numericInput(inputId = "y_axis_min", label = HTML('<span style="font-weight: normal;">Min</span>'), step = 0.1, value = "")
                                                     ),
                                                     div(
                                                       style = "flex: 1;",
                                                       # Numeric Input field for the max Y-Axis value
                                                       numericInput(inputId = "y_axis_max", label = HTML('<span style="font-weight: normal;">Max</span>'), step = 0.1, value = "")
                                                     )
                                                   )                                
                                               ),
                                               checkboxInput(inputId = "exact_axis_range", label = "Abstand bis zu Achsen-Ende", value = TRUE)
                                             ),
                                             
                                             # Create a Collapse-Panel for Errorbar-Settings
                                             bsCollapsePanel(
                                               # Define Title of Collapse-Panel
                                               title = BSCollapseArrow("Fehlerbalken"),
                                               # Define CSS Settings
                                               div(class = ".collapse_panel-settings",
                                                   # Dropdown to select the type of Errorbar
                                                   selectInput(inputId = "error_type", label = "Einheit", choices = c("Keiner", "Standardabweichung", "Konfidenzintervall", "Standardfehler"), selected = "Standardabweichung"),
                                                   # Numeric Input for the width of the Errorbar
                                                   numericInput(inputId = "error_mult", label = "Anzahl Einheiten", min = 1, step = 1, value = 1),
                                                   # Numeric Input for the width of the Errorbar
                                                   numericInput(inputId = "error_width", label = "Breite der Fehlerbalken", min = 0, max = 2, step = 0.1, value = "")
                                               )
                                             ),
                                             
                                             # Create a Collapse-Panel for Group-Settings
                                             bsCollapsePanel(
                                               # Define Title of Collapse-Panel
                                               title = BSCollapseArrow("Abstände der Gruppierungs-Variable"),
                                               # Define CSS Settings
                                               div(class = ".collapse_panel-settings",
                                                   # Numeric Input for the position-dodge value
                                                   numericInput(inputId = "dodge_value", label = "Abstand", min = 0, max = 2, step = 0.1, value = "")
                                               )
                                             ),

                                             # Create a Collapse-Panel for Color-Palette-Settings
                                             bsCollapsePanel(
                                               # Define Title of Collapse-Panel
                                               title = BSCollapseArrow("Farbpalletten"),
                                               # Define CSS Settings
                                               div(class = ".collapse_panel-settings",
                                                   # Dropdown with options for color-palette
                                                   selectInput(inputId = "Color_Palette", label = "Farbpalette", 
                                                               choices = c("Gemäss Theme", "Eigene Farbpalette erstellen", "viridis", "viridis - magma", "viridis - plasma", "viridis - inferno",
                                                                           "viridis - cividis", "viridis - mako", "viridis - rocket", "viridis - turbo",
                                                                           "Accent", "Blues", "Greens", "Greys", "Oranges", "Paired", "Pastel1", 
                                                                           "Pastel2", "Purples", "Reds", "Set1", "Set2", "Set3", "Spectral", 
                                                                           "grey", "hue", "ordinal", "aas", "bmj", "cosmic", "d3", "flatui", 
                                                                           "frontiers", "futurama", "igv", "jama", "lancet", "locuszoom", 
                                                                           "material", "nejm", "npg", "observable", "rickandmorty", "simpsons", "startrek", 
                                                                           "tron", "uchicago", "ucscgb", "jco", "calc", "canva", "colorblind", 
                                                                           "economist", "excel", "excel_new", "few", "fivethirtyeight", "gdocs", 
                                                                           "hc", "pander", "ptol", "solarized", 
                                                                           "stata", "tableau", "wsj"), selected = "Gemäss Theme"),
                                                   
                                                   # Set UI for individual color palette
                                                   conditionalPanel(condition = "input.Color_Palette =='Eigene Farbpalette erstellen'",
                                                                    # Add Button
                                                                    actionButton("add", "Farbe hinzufügen"),
                                                                    actionButton("remove_last", "Letzte Farbe entfernen"),
                                                                    tags$div(id = "input_container"),
                                                                    
                                                                    # Create CSS for inavlid colors
                                                                    tags$style(HTML("
                                                                      .invalid { background-color: #ffcccc !important; }
                                                                      .error-message { color: red; font-size: 14px; margin-left: 10px; display: inline; }
                                                                    ")),
                                                                    
                                                                    # JS to validate colors
                                                                    tags$script(HTML("
                                                                      Shiny.addCustomMessageHandler('validColor', function(data) {
                                                                        var inputField = document.getElementById(data.id);
                                                                        var errorText = document.getElementById(data.id + '_error');
                                                                        
                                                                        if (data.valid) {
                                                                          inputField.classList.remove('invalid');
                                                                          if (errorText) errorText.style.display = 'none';
                                                                        } else {
                                                                          inputField.classList.add('invalid');
                                                                          if (errorText) errorText.style.display = 'inline';
                                                                        }
                                                                      });
                                                                    "))
                                                                    ),
                                                   
                                                   selectInput(inputId = "color_palette_target", label = "Farbelette anwenden auf...", 
                                                               choices = c("Füllung", "Linien", "Füllung und Linien"), selected = "Füllung")
                                                   )
                                               )
                                             )
                                  ),
                 
                 
                 
                 
                 
                 
                 ########## 2.2.4 Text ##########
                 # Define Conditional-Panel for when text tab is selected
                 conditionalPanel(condition = "input.activeTab == 'text'",
                                  # Text-Input for the Title
                                  textInput(inputId = "plot_title", label = "Titel", value = "", placeholder = "Titel eingeben"),
                                  # Text-Input for the Sub-Title
                                  textInput(inputId = "plot_subtitle", label = "Untertitel", value = "", placeholder = "Untertitel eingeben"),
                                  # Text-Input for the X-Axis-Title
                                  textInput(inputId = "x_axis_title", label = "X-Achsen-Beschriftung", value = "", placeholder = "Eigene X-Achsen Beschriftung eingeben"),
                                  # Text-Input for the Y-Axis-Title
                                  textInput(inputId = "y_axis_title", label = "Y-Achsen-Beschriftung", value = "", placeholder = "Eigene Y-Achsen Beschriftung eingeben"),
                                  # Text-Input for the Legend-Title
                                  textInput(inputId = "legend_title", label = "Legenden-Beschriftung", value = "", placeholder = "Eigene Legenden Beschriftung eingeben")
                 ),
                 
                 
                 
                 
                 
                 ########## 2.2.5 Layout ##########
                 # Define Conditional-Panel for when layout tab is selected
                 conditionalPanel(condition = "input.activeTab == 'layout'",
                                  bsCollapse(id = "collapseExample", multiple = FALSE, open = NULL,
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Überschrift"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("Titel"),
                                                          # Text-Input for the Title
                                                          selectInput(inputId = "Title_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Title_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Title_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Title_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "Title_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   ),
                                                   column(6,
                                                          h3("Untertitel"),
                                                          title = BSCollapseArrow("Untertitel"),
                                                          # Text-Input for the X-Axis-Title
                                                          selectInput(inputId = "Subtitle_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Subtitle_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Subtitle_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Subtitle_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "Subtitle_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Achsen Überschrift"),
                                               div(class = ".collapse_panel-settings", 
                                                   column(6,
                                                          h3("X-Achse"),
                                                          # Text-Input for the X-Axis-Title
                                                          selectInput(inputId = "X_Axis_Title_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "X_Axis_Title_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "X_Axis_Title_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "X_Axis_Title_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "X_Axis_Title_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   ),
                                                   column(6, 
                                                          h3("Y-Achse"),
                                                          # Text-Input for the Y-Axis-Title
                                                          selectInput(inputId = "Y_Axis_Title_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Y_Axis_Title_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Y_Axis_Title_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Y_Axis_Title_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "Y_Axis_Title_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Achsen-Text"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("X Achse"),
                                                          # Text-Input for the X-Axis Label
                                                          selectInput(inputId = "Axis_X_Text_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Axis_X_Text_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Axis_X_Text_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Axis_X_Text_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          numericInput(inputId = "Axis_X_Text_Rotation", label = "Rotation", min = 0, max = 360, step = 1, value = NA),
                                                          selectInput(inputId = "Axis_X_Text_H_Alignment", label = "Vertikale Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Axis_X_Text_V_Alignment", label = "Horizonalte Ausrichtung", choices = c("Gemäss Theme", "Unten", "Mittig", "Oben"), selected = "Gemäss Theme")
                                                   ),
                                                   column(6,
                                                          h3("Y Achse"),
                                                          # Text-Input for the Y-Axis Label
                                                          selectInput(inputId = "Axis_Y_Text_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Axis_Y_Text_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Axis_Y_Text_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Axis_Y_Text_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          numericInput(inputId = "Axis_Y_Text_Rotation", label = "Rotation", min = 0, max = 360, step = 1, value = NA),
                                                          selectInput(inputId = "Axis_Y_Text_H_Alignment", label = "Vertikale Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Axis_Y_Text_V_Alignment", label = "Horizonalte Ausrichtung", choices = c("Gemäss Theme", "Unten", "Mittig", "Oben"), selected = "Gemäss Theme")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Achsen-Linien"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("X-Achse"),
                                                          selectInput(inputId = "Axis_X_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Axis_X_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Axis_X_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   ),
                                                   column(6,
                                                          h3("Y-Achse"),
                                                          selectInput(inputId = "Axis_Y_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Axis_Y_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Axis_Y_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Achsen-Ticks"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("X-Achse"),
                                                          selectInput(inputId = "Axis_X_Ticks_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Axis_X_Ticks_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Axis_X_Ticks_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Axis_X_Ticks_Length", label = "Länge", min = 0, max = 50, step = 0.1, value = NA)
                                                   ),
                                                   column(6,
                                                          h3("Y-Achse"),
                                                          selectInput(inputId = "Axis_Y_Ticks_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Axis_Y_Ticks_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Axis_Y_Ticks_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Axis_Y_Ticks_Length", label = "Länge", min = 0, max = 50, step = 0.1, value = NA)
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Haupt-Linien"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("X-Achse"),
                                                          selectInput(inputId = "Major_Grid_X_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Major_Grid_X_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Major_Grid_X_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   ),
                                                   column(6,
                                                          h3("Y-Achse"),
                                                          selectInput(inputId = "Major_Grid_Y_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Major_Grid_Y_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Major_Grid_Y_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Minor-Linien"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("X-Achse"),
                                                          selectInput(inputId = "Minor_Grid_X_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Minor_Grid_X_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Minor_Grid_X_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   ),
                                                   column(6,
                                                          h3("Y-Achse"),
                                                          selectInput(inputId = "Minor_Grid_Y_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Minor_Grid_Y_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Minor_Grid_Y_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Hintergrund"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("Plot"),
                                                          textInput(inputId = "Plot_Background_Color", label = "Hintergrund-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          selectInput(inputId = "Plot_Background_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Plot_Background_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Plot_Background_Line_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   ),
                                                   column(6,
                                                          h3("Panel"),
                                                          textInput(inputId = "Panel_Background_Color", label = "Hintergrund-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          selectInput(inputId = "Panel_Background_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Panel_Background_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Panel_Background_Line_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Legende"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("Titel"),
                                                          # Text-Input for the Legend-Title
                                                          selectInput(inputId = "Legend_Title_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Legend_Title_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Legend_Title_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Legend_Title_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "Legend_Title_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   ),
                                                   column(6,
                                                          h3("Items"),
                                                          # Text-Input for the X-Axis-Title
                                                          selectInput(inputId = "Legend_Text_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Legend_Text_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Legend_Text_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Legend_Text_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "Legend_Text_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Legenden Hintergrund"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("Legenden-Box"),
                                                          title = BSCollapseArrow("Legenden-Hintergrund"),
                                                          textInput(inputId = "Legend_Background_Color", label = "Hintergrund-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          selectInput(inputId = "Legend_Background_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Legend_Background_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Legend_Background_Line_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Legenden Optionen"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("Anordnung"),
                                                          selectInput(inputId = "Legend_Position", label = "Position der Legende", choices = c("Gemäss Theme", "Keine", "Rechts", "Links", "Unten", "Oben", "Im Plot"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Legend_Title_Position", label = "Position des Legenden-Titel", choices = c("Gemäss Theme", "Oben", "Rechts", "Links", "Unten"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Legend_Text_Position", label = "Position der Legenden-Items", choices = c("Gemäss Theme", "Oben", "Rechts", "Links", "Unten"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Legend_Text_Direktion", label = "Ausrichtung der Legenden-Items", choices = c("Gemäss Theme", "Vertikal", "Horizontal"), selected = "Gemäss Theme")
                                                   ),
                                                   column(6,
                                                          h3("Grösse & Abstände"),
                                                          numericInput(inputId = "Legend_Key_Width", label = "Breite der Symbole", min = 0, max = 50, step = 0.1, value = NA),
                                                          numericInput(inputId = "Legend_Key_Height", label = "Höhe der Symbole", min = 0, max = 50, step = 0.1, value = NA),
                                                          numericInput(inputId = "Legend_Key_Spacing", label = "Abstand der Symbole", min = 0, max = 50, step = 0.1, value = NA),
                                                          numericInput(inputId = "Legend_Box_Spacing", label = "Abstand zum Plot", min = 0, max = 50, step = 0.1, value = NA)
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Facetten Hintergrund"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("Zeilen"),
                                                          textInput(inputId = "Stripe_X_Color", label = "Hintergrund-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          selectInput(inputId = "Stripe_X_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Stripe_X_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Stripe_X_Line_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   ),
                                                   column(6,
                                                          h3("Spalten"),
                                                          textInput(inputId = "Stripe_Y_Color", label = "Hintergrund-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          selectInput(inputId = "Stripe_Y_Linetype", label = "Linien-Art", choices = c("Gemäss Theme", "Keine", "Solide", "Gestrichelt", "Gepunkted", "Punktgestrichelt", "Langgestrichen", "Doppelt gestrichelt"), selected = "Gemäss Theme"),
                                                          numericInput(inputId = "Stripe_Y_Size", label = "Linien-Grösse", min = 0, max = 50, step = 0.1, value = NA),
                                                          textInput(inputId = "Stripe_Y_Line_Color", label = "Linien-Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen")
                                                   )
                                               )
                                             ),
                                             bsCollapsePanel(
                                               title = BSCollapseArrow("Facetten-Beschriftung"),
                                               div(class = ".collapse_panel-settings",
                                                   column(6,
                                                          h3("Zeilen"),
                                                          selectInput(inputId = "Stripe_X_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Stripe_X_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Stripe_X_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Stripe_X_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "Stripe_X_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   ),
                                                   column(6,
                                                          h3("Spalten"),
                                                          selectInput(inputId = "Stripe_Y_Font", label = "Schriftart", choices = c("Gemäss Theme", "Sans Serife", "Serife", "Monospace"), selected = "Gemäss Theme"),
                                                          selectInput(inputId = "Stripe_Y_Face", label = "Formatierung", choices = c("Gemäss Theme", "Normal", "Fett", "Kursiv", "Fett & Kursiv"), selected = "Gemäss Theme"),
                                                          textInput(inputId = "Stripe_Y_Color", label = "Farbe", value = "", placeholder = "Farbe eingeben zum Anpassen"),
                                                          numericInput(inputId = "Stripe_Y_Size", label = "Grösse", min = 0, max = 96, step = 0.1, value = NA),
                                                          selectInput(inputId = "Stripe_Y_Alignment", label = "Ausrichtung", choices = c("Gemäss Theme", "Linksbündig", "Mittig", "Rechtsbündig"), selected = "Gemäss Theme")
                                                   )
                                               )
                                             )
                                  )
                 ),
                 
                 
                 
                 
                 
                 ########## 2.2.6 Download ##########
                 # Define Conditional-Panel for when Download tab is selected
                 conditionalPanel(condition = "input.activeTab == 'download'",
                                  fluidRow(
                                    column(6,
                                           h3("Plot"),
                                           # create a Download-Button for Plot
                                           downloadButton("downloadPlot", "Plot herunterladen"),
                                           # Define File-format
                                           selectInput("file_format", "Dateiformat:", 
                                                       choices = c("PNG" = "png", "JPEG" = "jpeg", "SVG" = "svg")),
                                    ),
                                    column(6,
                                           h3("R-Code"),
                                           # create a Download-Button for RCode
                                           downloadButton("downloadCode", "Code herunterladen")
                                    ),
                                  )
                 )
    ),
    
    
    
    
    
    
    
    
    ############### 2.3 Main Panel ###############
    ########## 2.3.1 Plot-Output ##########
    # Define the Main-Panel
    mainPanel(
      # Set the plot as output
      uiOutput("dynamic_plot"),

      
      
      
      ########## 2.3.2 Code-Output ##########
      # Add TextOutput for rcode
      column(11,
             verbatimTextOutput("rcode"),
             ),
      column(1,
             rclipboardSetup(),
             
             # UI output for copy-to-clipboard button
             uiOutput("clip"),
             )
    )
  )
)




















#################### 3. Server ####################
server <- function(input, output, session) {
  ############### 3. Define reactive Values ###############
  X_Factors <- reactiveValues(values = NA)
  is_numeric_x <- reactiveVal(NULL)
  is_numeric_y <- reactiveVal(value = NA)
  is_numeric_group <- reactiveVal(value = NA)
  is_numeric_grid_col <- reactiveVal(value = NA)
  is_numeric_grid_row <- reactiveVal(value = NA)
  # Manual Colors for color palette
  manual_colors <- reactiveValues(values = list(), count = 0)  # Zähler für IDs
  
  
  ############### 3.1 Read Data ###############
  # Create a reactive data with the loaded data
  data <- reactive({
    if (is.null(input$file)) {
      # Rückgabe eines leeren Standard-Datensatzes, wenn keine Datei geladen wurde
      return(data.frame(
        Placeholder_X = numeric(0),
        Placeholder_Y = numeric(0)
      ))
    } else {
      # If input-file is selected
      req(input$file)
      # Get the type of selected file
      file_ext <- tools::file_ext(input$file$name)
      
      # If file type is csv, read csv-File
      if (file_ext == "csv") {
        return(read.csv(input$file$datapath, header = TRUE))
      }
      # If file type is xlsx, read xlsx-File
      else if (file_ext == "xlsx") {
        return(readxl::read_excel(input$file$datapath))
      }
      # If file type is rds, load rds-File
      else if (file_ext == "rds") {
        return(readRDS(input$file$datapath))
      }
      # If file type is rds, load rds-File
      else if (file_ext == "rdata") {
        # Create new environment
        env <- new.env()
        
        # Load file
        load(input$file$datapath, envir = env)
        
        # List all files in environment
        obj_names <- ls(env)
        
        # Select first object of .RData-File if there is only one object
        if (length(obj_names) == 1) {
          return(env[[obj_names[1]]])
          # Give error-message if there are more objects in the .RData-File
        } else {
          stop("Das .RData-File beinhaltet mehrere Objekte. Bitte .RData-File mit nur einem Objekt verwenden.")
        }
      }
      # If file is other type, stop
      else {
        stop("Unbekanntes Dateiformat. Bitte laden Sie eine CSV-, XLSX-, rdata oder RDS-Datei hoch.")
      }
    }})
  
  
  # Create reactive Value for active Tab
  activeTab <- reactiveVal("data")
  # Create reactive Value for active Plot
  activePlot <- reactiveVal("data")
  
  # Observe button-inputs for btn_data
  observeEvent(input$btn_data, {
    # Define the active Tab
    activeTab("data")
    # Set Button to active version
    session$sendCustomMessage("setActiveButton", "btn_data")
  })
  # Observe button-inputs for btn_plottype
  observeEvent(input$btn_plottype, {
    # Define the active Tab
    activeTab("plottype")
    # Set Button to active version
    session$sendCustomMessage("setActiveButton", "btn_plottype")
  })
  # Observe button-inputs for btn_variables
  observeEvent(input$btn_variables, {
    # Define the active Tab
    activeTab("variables")
    # Set Button to active version
    session$sendCustomMessage("setActiveButton", "btn_variables")
  })
  # Observe button-inputs for btn_plot_options
  observeEvent(input$btn_plot_options, {
    # Define the active Tab
    activeTab("plot_options")
    # Set Button to active version
    session$sendCustomMessage("setActiveButton", "btn_plot_options")
  })
  # Observe button-inputs for btn_text
  observeEvent(input$btn_text, {
    # Define the active Tab
    activeTab("text")
    # Set Button to active version
    session$sendCustomMessage("setActiveButton", "btn_text")
  })
  # Observe button-inputs for btn_layout
  observeEvent(input$btn_layout, {
    # Define the active Tab
    activeTab("layout")
    # Set Button to active version
    session$sendCustomMessage("setActiveButton", "btn_layout")
  })
  # Observe button-inputs for btn_download
  observeEvent(input$btn_download, {
    # Define the active Tab
    activeTab("download")
    # Set Button to active version
    session$sendCustomMessage("setActiveButton", "btn_download")
  })
  
  # Observe button-inputs for plot_bar
  observeEvent(input$plot_bar, {
    # Define the active Plot
    activePlot("Bar")
    # Set Button to active version
    session$sendCustomMessage("setActivePlot", "plot_bar")
  })
  # Observe button-inputs for plot_box
  observeEvent(input$plot_box, {
    # Define the active Plot
    activePlot("Box")
    # Set Button to active version
    session$sendCustomMessage("setActivePlot", "plot_box")
  })
  # Observe button-inputs for plot_line
  observeEvent(input$plot_line, {
    # Define the active Plot
    activePlot("Line")
    # Set Button to active version
    session$sendCustomMessage("setActivePlot", "plot_line")
  })
  # Observe button-inputs for plot_scatter
  observeEvent(input$plot_scatter, {
    # Define the active Plot
    activePlot("Scatter")
    # Set Button to active version
    session$sendCustomMessage("setActivePlot", "plot_scatter")
  })
  
  
  
  # Observe the input buttons to observe the active tabs
  observeEvent(input$btn_data, { activeTab("data") })
  observeEvent(input$btn_plottype, { activeTab("plottype") })
  observeEvent(input$btn_variables, { activeTab("variables") })
  observeEvent(input$btn_plot_options, { activeTab("plot_options") })
  observeEvent(input$btn_text, { activeTab("text") })
  observeEvent(input$btn_layout, { activeTab("layout") })
  observeEvent(input$btn_download, { activeTab("download") })
  
  # Make active tab accessible
  observe({
    updateTextInput(session, "activeTab", value = activeTab())
  })
  
  
  
  
  
  
  
  
  ############### 3.2 Update Variable Dropdown ###############
  observeEvent(data(), {
    updateSelectInput(session, "x_var", choices = c("Keine Variable" = " ", names(data())), selected = " ")
    updateSelectInput(session, "y_var", choices = c("Keine Variable" = " ", names(data())), selected = " ")
    updateSelectInput(session, "group_var", choices = c("Keine Variable" = " ", names(data())), selected = " ")
    updateSelectInput(session, "grid_col_var", choices = c("Keine Variable" = " ", names(data())), selected = " ")
    updateSelectInput(session, "grid_row_var", choices = c("Keine Variable" = " ", names(data())), selected = " ")
  })
  
  
  
  
  
  
  
  
  ############### 3.X Update Variable Selection ###############
  Factors <- reactiveValues(values = c(""))  # Reaktive Liste
  
  observeEvent(list(input$x_var, input$y_var, input$group_var, input$grid_col_var, input$grid_row_var), {
    req(data())  
    req(input$x_var)  
    req(input$y_var)  
    req(input$group_var)  
    req(input$grid_col_var)  
    req(input$grid_row_var)  

    
    x_data <- data()[[input$x_var]]
    y_data <- data()[[input$y_var]]
    goup_data <- data()[[input$group_var]]
    grid_col_data <- data()[[input$grid_col_var]]
    grid_row_data <- data()[[input$grid_row_var]]
    
    if (is.factor(x_data)) {
      Factors$x_values <- levels(x_data)
      is_numeric_x(FALSE)
    } else if (is.character(x_data)) {
      Factors$x_values <- unique(x_data)
      is_numeric_x(FALSE)
    } else {
      Factors$x_values <- c("")
      is_numeric_x(TRUE)
    }
    
    if (is.factor(y_data)) {
      Factors$y_values <- levels(y_data)
    } else if (is.character(y_data)) {
      Factors$y_values <- unique(y_data)
    } else {
      Factors$y_values <- c("")
    }
    
    if (is.factor(goup_data)) {
      Factors$group_values <- levels(goup_data)
    } else if (is.character(goup_data)) {
      Factors$group_values <- unique(goup_data)
    } else {
      Factors$group_values <- c("")
    }
    
    if (is.factor(grid_col_data)) {
      Factors$grid_cols_values <- levels(grid_col_data)
    } else if (is.character(grid_col_data)) {
      Factors$grid_cols_values <- unique(grid_col_data)
    } else {
      Factors$grid_cols_values <- c("")
    }
    
    if (is.factor(grid_row_data)) {
      Factors$grid_row_values <- levels(grid_row_data)
    } else if (is.character(grid_row_data)) {
      Factors$grid_row_values <- unique(grid_row_data)
    } else {
      Factors$grid_row_values <- c("")
    }
  })
  
  output$is_numeric_x <- reactive({
    req(input$x_var, data())  # Stelle sicher, dass x_var existiert
    
    x_data <- data()[[input$x_var]]
    
    if (is.factor(x_data) || is.character(x_data)) {
      return(FALSE)  # Kein numerischer Wert
    } else {
      return(TRUE)  # Numerischer Wert
    }
  })
  
  
  output$is_numeric_y <- reactive({
    req(input$y_var, data())  # Stelle sicher, dass x_var existiert
    
    y_data <- data()[[input$y_var]]
    
    if (is.factor(y_data) || is.character(y_data)) {
      return(FALSE)  # Kein numerischer Wert
    } else {
      return(TRUE)  # Numerischer Wert
    }
  })
  
  
  output$is_numeric_group <- reactive({
    req(input$group_var, data())  # Stelle sicher, dass x_var existiert
    
    group_data <- data()[[input$group_var]]
    
    if (is.factor(group_data) || is.character(group_data)) {
      return(FALSE)  # Kein numerischer Wert
    } else {
      return(TRUE)  # Numerischer Wert
    }
  })
  
  
  output$is_numeric_col <- reactive({
    req(input$grid_col_var, data())  # Stelle sicher, dass x_var existiert
    
    gridcol_data <- data()[[input$grid_col_var]]
    
    if (is.factor(gridcol_data) || is.character(gridcol_data)) {
      return(FALSE)  # Kein numerischer Wert
    } else {
      return(TRUE)  # Numerischer Wert
    }
  })
  
  
  output$is_numeric_row <- reactive({
    req(input$grid_row_var, data())  # Stelle sicher, dass x_var existiert
    
    grid_row <- data()[[input$grid_row_var]]
    
    if (is.factor(grid_row) || is.character(grid_row)) {
      return(FALSE)  # Kein numerischer Wert
    } else {
      return(TRUE)  # Numerischer Wert
    }
  })
  
  # Hide Output variables
  outputOptions(output, "is_numeric_x", suspendWhenHidden = FALSE)
  outputOptions(output, "is_numeric_y", suspendWhenHidden = FALSE)
  outputOptions(output, "is_numeric_group", suspendWhenHidden = FALSE)
  outputOptions(output, "is_numeric_col", suspendWhenHidden = FALSE)
  outputOptions(output, "is_numeric_row", suspendWhenHidden = FALSE)
  
  
  # Reset factor codes
  observeEvent(input$x_var, {
    x_factor_code("")
    factor_code(paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code()))})
  
  observeEvent(input$y_var, {
    y_factor_code("")
    factor_code(paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code()))})
  
  observeEvent(input$group_var, {
    group_factor_code("")
    factor_code(paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code()))})
  
  observeEvent(input$grid_col_var, {
    grid_col_factor_code("")
    factor_code(paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code()))})
  
  observeEvent(input$grid_row_var, {
    grid_row_factor_code("")
    factor_code(paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code()))})
  
  # Create dynamic UI for rank_list()
  output$x_factor_rank_list <- renderUI({
    rank_list(input_id = "x_factor_Order", 
              labels = Factors$x_values,  
              options = sortable_options(swap = TRUE))
  })
  
  # Create dynamic UI for rank_list()
  output$y_factor_rank_list <- renderUI({
    rank_list(input_id = "y_factor_Order", 
              labels = Factors$y_values,  
              options = sortable_options(swap = TRUE))
  })
  
  # Create dynamic UI for rank_list()
  output$group_factor_rank_list <- renderUI({
    rank_list(input_id = "group_factor_Order", 
              labels = Factors$group_values,  
              options = sortable_options(swap = TRUE))
  })
  
  # Create dynamic UI for rank_list()
  output$grid_col_factor_rank_list <- renderUI({
    rank_list(input_id = "grid_col_factor_Order", 
              labels = Factors$grid_cols_values,  
              options = sortable_options(swap = TRUE))
  })
  
  # Create dynamic UI for rank_list()
  output$grid_row_factor_rank_list <- renderUI({
    rank_list(input_id = "grid_row_factor_Order", 
              labels = Factors$grid_row_values,  
              options = sortable_options(swap = TRUE))
  })

  
  
  
  

  
  
  
  ############### 3.X Check for changes ###############
  # Create reactive factor_code
  factor_code <- reactiveVal(value = "")
  x_factor_code <- reactiveVal(value = "")
  y_factor_code <- reactiveVal(value = "")
  group_factor_code <- reactiveVal(value = "")
  grid_col_factor_code <- reactiveVal(value = "")
  grid_row_factor_code <- reactiveVal(value = "")
  
  # Check for Update on order of levels on x-factor
  observeEvent(input$x_factor_Order, {
    # Require data
    req(data(), input$x_factor_Order, input$x_var)
    
    # Initate new_factor_code
    new_x_factor_code <- ""
    
    # Check if order has changed
    if (!identical(Factors$x_values, input$x_factor_Order)) {
      # Adjust factors if variable is factor
      if (is.factor(data()[[input$x_var]])) {
        new_x_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))", 
                               input$x_var, input$x_var, 
                               paste(sprintf("'%s'", input$x_factor_Order), collapse = ", "))
      } 
      # Make factor if variable is not a factor
      else if (is.character(data()[[input$x_var]])) {
        new_x_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))", 
                               input$x_var, input$x_var, 
                               paste(sprintf("'%s'", input$x_factor_Order), collapse = ", "))
      }
    }
    
    # Update reactive x-factor variable
    x_factor_code(new_x_factor_code)
    
    # Create new factor-code
    new_factor_code <- paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code())
    
    # Update factor_code
    factor_code(new_factor_code)
  })
  
  # Check for Update on order of levels on y-factor
  observeEvent(input$y_factor_Order, {
    # Require data
    req(data(), input$y_factor_Order, input$y_var)
    
    # Initate new_factor_code
    new_y_factor_code <- ""
    
    # Check if order has changed
    if (!identical(Factors$y_values, input$y_factor_Order)) {
      # Adjust factors if variable is factor
      if (is.factor(data()[[input$y_var]])) {
        new_y_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))", 
                                   input$y_var, input$y_var, 
                                   paste(sprintf("'%s'", input$y_factor_Order), collapse = ", "))
      } 
      # Make factor if variable is not a factor
      else if (is.character(data()[[input$y_var]])) {
        new_y_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))", 
                                   input$y_var, input$y_var, 
                                   paste(sprintf("'%s'", input$y_factor_Order), collapse = ", "))
      }
    }
    
    # Update reactive y-factor variable
    y_factor_code(new_y_factor_code)
    
    # Create new factor-code
    new_factor_code <- paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code())
    
    # Update factor_code
    factor_code(new_factor_code)
  })
  
  # Check for Update on order of levels on grouping-factor
  observeEvent(input$group_factor_Order, {
    # Require data
    req(data(), input$group_factor_Order, input$group_var)

    # Initate new_factor_code
    new_group_factor_code <- ""

    # Check if order has changed
    if (!identical(Factors$group_values, input$group_factor_Order)) {
      # Adjust factors if variable is factor
      if (is.factor(data()[[input$group_var]])) {
        new_group_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))",
                                     input$group_var, input$group_var,
                                     paste(sprintf("'%s'", input$group_factor_Order), collapse = ", "))
      }
      # Make factor if variable is not a factor
      else if (is.character(data()[[input$group_var]])) {
        new_group_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))",
                                     input$group_var, input$group_var,
                                     paste(sprintf("'%s'", input$group_factor_Order), collapse = ", "))
      }
    }

    # Update reactive group-factor variable
    group_factor_code(new_group_factor_code)

    # Create new factor-code
    new_factor_code <- paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code())
    
    # Update factor_code
    factor_code(new_factor_code)
  })
  
  # Check for Update on order of levels on grid-column-factor
  observeEvent(input$grid_col_factor_Order, {
    # Require data
    req(data(), input$grid_col_factor_Order, input$grid_col_var)
    
    # Initate new_factor_code
    new_gridcol_factor_code <- ""
    
    # Check if order has changed
    if (!identical(Factors$group_values, input$grid_col_factor_Order)) {
      # Adjust factors if variable is factor
      if (is.factor(data()[[input$grid_col_var]])) {
        new_gridcol_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))",
                                         input$grid_col_var, input$grid_col_var,
                                         paste(sprintf("'%s'", input$grid_col_factor_Order), collapse = ", "))
      }
      # Make factor if variable is not a factor
      else if (is.character(data()[[input$grid_col_var]])) {
        new_gridcol_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))",
                                         input$grid_col_var, input$grid_col_var,
                                         paste(sprintf("'%s'", input$grid_col_factor_Order), collapse = ", "))
      }
    }
    
    # Update reactive group-factor variable
    grid_col_factor_code(new_gridcol_factor_code)
    
    # Create new factor-code
    new_factor_code <- paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code())
    
    # Update factor_code
    factor_code(new_factor_code)
  })
  
  # Check for Update on order of levels on grid-row-factor
  observeEvent(input$grid_row_factor_Order, {
    # Require data
    req(data(), input$grid_row_factor_Order, input$grid_row_var)
    
    # Initate new_factor_code
    new_gridrow_factor_code <- ""
    
    # Check if order has changed
    if (!identical(Factors$grid_row_values, input$grid_row_factor_Order)) {
      # Adjust factors if variable is factor
      if (is.factor(data()[[input$grid_row_var]])) {
        new_gridrow_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))",
                                           input$grid_row_var, input$grid_row_var,
                                           paste(sprintf("'%s'", input$grid_row_factor_Order), collapse = ", "))
      }
      # Make factor if variable is not a factor
      else if (is.character(data()[[input$grid_row_var]])) {
        new_gridrow_factor_code <- sprintf("\ndf$'%s' <- factor(df$'%s', levels = c(%s))",
                                           input$grid_row_var, input$grid_row_var,
                                           paste(sprintf("'%s'", input$grid_row_factor_Order), collapse = ", "))
      }
    }
    
    # Update reactive group-factor variable
    grid_row_factor_code(new_gridrow_factor_code)
    
    # Create new factor-code
    new_factor_code <- paste(x_factor_code(), y_factor_code(), group_factor_code(), grid_col_factor_code(), grid_row_factor_code())
    
    # Update factor_code
    factor_code(new_factor_code)
  })
  
  
  
  
  
  
  
  
  
  ############### 3.X Update Manual Color Palette ###############
  # When "Add" is Pressed
  observeEvent(input$add, {
    # Increase counter of ID's
    manual_colors$count <- manual_colors$count + 1  # Erhöhe den Zähler für eine neue ID
    # Set new couner ID
    new_id <- manual_colors$count
    
    # Insert new UI
    insertUI(
      selector = "#input_container",
      where = "beforeEnd",
      ui = tags$div(
        id = paste0("input_row_", new_id),
        style = "display: flex; align-items: center;",
        textInput(paste0("vector_", new_id), 
                  label = paste("Color", new_id), 
                  placeholder = "z.B. 'red', 'grey', '#F00F1F'"),
        tags$span(id = paste0("vector_", new_id, "_error"), 
                  class = "error-message", 
                  "Keine gültige Farbe angegeben", 
                  style = "display: none;")
      )
    )
    
    # Create new entries using a standard-color
    manual_colors$values[[as.character(new_id)]] <- "gray"
    
    # Observe all entries
    observe({for (id in names(manual_colors$values)) {
      color <- input[[paste0("vector_", id)]]
      if (!is.null(color)) {
        if (is_valid_color(color)) {
          manual_colors$values[[id]] <- color
          session$sendCustomMessage("validColor", list(id = paste0("vector_", id), valid = TRUE))
          } else {
            manual_colors$values[[id]] <- "gray"
            session$sendCustomMessage("validColor", list(id = paste0("vector_", id), valid = FALSE))
          }
      }
    }
    })
  })
  
  # When "Remove" is Pressed
  observeEvent(input$remove_last, {
    # If there is at least one color defined
    if (manual_colors$count > 0) {
      # Remove last element of manual_colors
      last_id <- as.character(manual_colors$count)
      # Remove UI
      removeUI(selector = paste0("#input_row_", last_id))  # UI entfernen
      # Remove Value of manual_colors
      manual_colors$values[[last_id]] <- NULL
      # Reduce counter of manual_colors
      manual_colors$count <- manual_colors$count - 1
    }
  })



  
  
  
  
  
  
  
  ############### 3.3 Generate Basic R-Code ###############
  # Define Code-Text
  r_code <- reactive({
    req(data())
    
    
    
    
    
    ########## 3.3.1 Set Variables Based on Input-Data ##########
    # X-Axis Variable
    x_var <- if (input$x_var == " ") "1" else input$x_var
    # Y-Axis Variable
    y_var <- if (input$y_var == " ") "1" else input$y_var
    # Grouping Variable
    group_var <- if (input$group_var == " ") NULL else input$group_var
    # Column Variable
    grid_col_var <- if (input$grid_col_var == " ") NULL else input$grid_col_var
    # Row Variable
    grid_row_var <- if (input$grid_row_var == " ") NULL else input$grid_row_var
    
    # Plot Title
    plot_title <- if (input$plot_title== "") NULL else input$plot_title
    # Plot Subtitle
    plot_subtitle <- if (input$plot_subtitle== "") NULL else input$plot_subtitle
    # X-Axis Title
    x_axis_title <- if (input$x_axis_title== "") NULL else input$x_axis_title
    # Y-Axis Title
    y_axis_title <- if (input$y_axis_title== "") NULL else input$y_axis_title
    # Legend Title
    legend_title <- if (input$legend_title== "") NULL else input$legend_title
    
    # Min Range of X-Axis
    x_axis_min <- if (is.na(input$x_axis_min)==TRUE) NA else input$x_axis_min
    # Max Range of X-Axis
    x_axis_max <- if (is.na(input$x_axis_max)==TRUE) NA else input$x_axis_max
    # Min Range of Y-Axis
    y_axis_min <- if (is.na(input$y_axis_min)==TRUE) NA else input$y_axis_min
    # Max Range of X-Axis
    y_axis_max <- if (is.na(input$y_axis_max)==TRUE) NA else input$y_axis_max
    
    # Errorbar Width
    error_width <- if (!is.na(input$error_width)) input$error_width else NULL
    # Position-Dodge value
    dodge_value <- if (is.na(input$dodge_value)==TRUE) NA else input$dodge_value
    # Selected Theme
    theme_selected <- input$plot_theme
    # Selected Color-Palette
    palette_selected <- input$Color_Palette

    
    
    
    
    ########## 3.3.2 Generate Code-Output ##########
    # Define Code Lines
    r_code <- sprintf("q <- ggplot(df, aes_string(x = '%s', y = '%s'", x_var, y_var)
    
    
    
    
    ########## 3.3.3 Add Grouping Variable ########## 
    # Define Grouping-variable if selected
    if (!is.null(group_var)) {
      if(input$color_palette_target == "Füllung"){
        r_code <- paste0(r_code, sprintf(", fill = '%s'))", group_var))
      }
      if(input$color_palette_target == "Linien"){
        r_code <- paste0(r_code, sprintf(", color = '%s'))", group_var))
      }
      if(input$color_palette_target == "Füllung und Linien"){
        r_code <- paste0(r_code, sprintf(", fill = '%s', color = '%s'))", group_var, group_var))
      }
      # Close first line of Plot-relevant Code if no Grouping Variable is selected
    } else {
      r_code <- paste0(r_code, sprintf("))"))
    }
    
    
    
    
    
    ########## 3.3.4 Define Bar-Geoms ########## 
    if (x_var != "1" && y_var != "1") {
      if (activePlot() == "Bar"|activePlot() == "Line"){
        if (activePlot() == "Bar"){
        r_code <- paste0(r_code, " +\n  stat_summary(fun = mean, geom = 'bar'")
        }
        if (activePlot() == "Line"){
          # r_code <- paste0(r_code, " +\n  stat_summary(fun = mean, geom = 'line'")
          if (!is.null(group_var)) {
            r_code <- paste0(r_code, sprintf(" +\n  stat_summary(aes_string(group = '%s', color = '%s'), fun = mean, geom = 'line'", group_var, group_var))
            # Close first line of Plot-relevant Code if no Grouping Variable is selected
          }
          if (is.null(group_var)) {
            r_code <- paste0(r_code, sprintf(" +\n  stat_summary(fun = mean, geom = 'line', group = 1"))
            # Close first line of Plot-relevant Code if no Grouping Variable is selected
          }
          
        }
        
        if (!is.na(dodge_value)) {
          r_code <- paste0(r_code, sprintf(", position = position_dodge(width = %s)", dodge_value))
        }
        r_code <- paste0(r_code, ")")
      
      
      
      
      ########## 3.3.5 Define Errorbar-Geom ##########       
      if (input$error_type != "Keiner") {
        r_code <- paste0(r_code, sprintf(" +\n  stat_summary(fun.data = %s, geom = 'errorbar'",
                                         switch(
                                           input$error_type,
                                           "Standardabweichung" = "mean_sdl",
                                           "Konfidenzintervall" = "mean_cl_normal",
                                           "Standardfehler" = "mean_se",
                                           "mean_sdl" # Default-Wert
                                         )))
        if (!is.null(error_width)) {
          r_code <- paste0(r_code, sprintf(", width = %s", error_width))
        }
        if (!is.na(dodge_value)) {
          r_code <- paste0(r_code, sprintf(", position = position_dodge(width = %s)", dodge_value))
        }
        if (((input$error_type != "Standardfehler") & (input$error_mult!=2) & !is.na(input$error_mult))|
            ((input$error_type == "Standardfehler") & (input$error_mult!=1) & !is.na(input$error_mult))){
          r_code <- paste0(r_code, sprintf(", fun.args = list(mult = %.0f)", input$error_mult))
        }
        r_code <- paste0(r_code, ")")
      }
        }
    }
    
    
    
    if (x_var != "1" && y_var != "1") {
      if (activePlot() == "Box"){
        r_code <- paste0(r_code, " +\n  geom_boxplot(")
        
        if (!is.na(dodge_value)) {
          r_code <- paste0(r_code, sprintf(", position = position_dodge(width = %s)", dodge_value))
        }
        r_code <- paste0(r_code, ")")
        
        
      }
      }
    
    
    
    if (x_var != "1" && y_var != "1") {
      if (activePlot() == "Scatter"){
        r_code <- paste0(r_code, " +\n  geom_point(")
        
        if (!is.na(dodge_value)) {
          r_code <- paste0(r_code, sprintf(", position = position_dodge(width = %s)", dodge_value))
        }
        r_code <- paste0(r_code, ")")
        
        
      }
    }
    
    
    
    ########## 3.3.6 Define Facets ##########  
    # Add Facets if defined
    if (!is.null(grid_col_var) & !is.null(grid_row_var)) {
      r_code <- paste0(r_code, sprintf(" +\n  facet_grid(rows = vars(%s), cols = vars(%s))", grid_row_var, grid_col_var))
    } else if (!is.null(grid_col_var)) {
      r_code <- paste0(r_code, sprintf(" +\n  facet_wrap(vars(%s))", grid_col_var))
    } else if (!is.null(grid_row_var)) {
      r_code <- paste0(r_code, sprintf(" +\n  facet_wrap(vars(%s))", grid_row_var))
    }
    
    
    
    
    
    ########## 3.3.7 Set Themes ##########  
    # Add themes if theme is not gray
    if (theme_selected != "Gray") {
      r_code <- paste0(r_code, sprintf(" +\n  %s",
                                       switch(theme_selected,
                                              "Bw" = "theme_bw()",
                                              "Classic" = "theme_classic()",
                                              "Gray" = "theme_gray()",
                                              "Linedraw" = "theme_linedraw()",
                                              "Light" = "theme_light()",
                                              "Dark" = "theme_dark()",
                                              "Minimal" = "theme_minimal()",
                                              "Void" = "theme_void()",
                                              "Calc" = "theme_calc()",
                                              "the Economist" = "theme_economist()",
                                              "the Economist White" = "theme_economist_white()",
                                              "Excel" = "theme_excel()",
                                              "Few" = "theme_few()",
                                              "FiveThirtyEight" = "theme_fivethirtyeight()",
                                              "Google Docs" = "theme_gdocs()",
                                              "Highcharts JS" = "theme_hc()",
                                              "Inversed Gray" = "theme_igray()",
                                              "Solarized" = "theme_solarized()",
                                              "Solarized 2" = "theme_solarized_2()",
                                              "Solid" = "theme_solid()",
                                              "Stata" = "theme_stata()",
                                              "Tufte" = "theme_tufte()",
                                              "Wall Street Journal" = "theme_wsj()",
                                              paste0("theme_", tolower(theme_selected), "()") # Fallback
          )
        )
      )
    }
    
    
    
    
    
    ########## 3.3.8 Set Labs ##########  
    labs_code <- ""
    
    if (!is.null(input$plot_title) && input$plot_title != "") {
      labs_code <- paste0(labs_code, sprintf("title = '%s'", input$plot_title))
    }
    if (!is.null(input$plot_subtitle) && input$plot_subtitle != "") {
      labs_code <- paste0(
        labs_code, 
        if (labs_code != "") ", " else "",
        sprintf("subtitle = '%s'", input$plot_subtitle)
      )
    }
    if (!is.null(input$x_axis_title) && input$x_axis_title != "") {
      labs_code <- paste0(
        labs_code, 
        if (labs_code != "") ", " else "",
        sprintf("x = '%s'", input$x_axis_title)
      )
    }
    if (!is.null(input$y_axis_title) && input$y_axis_title != "") {
      labs_code <- paste0(
        labs_code, 
        if (labs_code != "") ", " else "",
        sprintf("y = '%s'", input$y_axis_title)
      )
    }
    if (!is.null(input$legend_title) && input$legend_title != "") {
      labs_code <- paste0(
        labs_code, 
        if (labs_code != "") ", " else "",
        sprintf("fill = '%s'", input$legend_title)
      )
    }
    
    # Add labs_code when labs were assigned
    if (labs_code != "") {
      r_code <- paste0(r_code, sprintf(" +\n  labs(%s)", labs_code))
    }
    
    
    
    
    
    ########## 3.3.9 X and Y-Axis Range ##########  
    # Define empty Code for axis_code
    axis_code <- ""
    
    # Adjust X-Axis range
    if (!is.na(x_axis_min) || !is.na(x_axis_max) ||! is.na(y_axis_min) || !is.na(y_axis_max) || !input$exact_axis_range) {
      axis_code <- "coord_cartesian("
      
      if (!is.na(x_axis_min) || !is.na(x_axis_max)) {
        axis_code <- paste0(axis_code, sprintf("xlim = c(%s, %s)", 
                                        if (!is.na(x_axis_min)) x_axis_min else "NA", 
                                        if (!is.na(x_axis_max)) x_axis_max else "NA"))

        if(!is.na(y_axis_min) || !is.na(y_axis_max)){
          axis_code <- paste0(axis_code, ", ")
        }
      }

      if (!is.na(y_axis_min) || !is.na(y_axis_max)) {
        axis_code <- paste0(axis_code, sprintf("ylim = c(%s, %s)", 
                                         if (!is.na(y_axis_min)) y_axis_min else "NA", 
                                         if (!is.na(y_axis_max)) y_axis_max else "NA"))
      }

      if (!input$exact_axis_range) {
        if(!is.na(y_axis_min) || !is.na(y_axis_max) || !is.na(x_axis_min) || !is.na(x_axis_max)){
          axis_code <- paste0(axis_code, ", ")
        }
        
        axis_code <- paste0(axis_code, "expand = FALSE")
      }
        
      axis_code <- paste0(axis_code, ")")
      
      r_code <- paste0(r_code, sprintf(" +\n  "), axis_code)
                          
    } else {
      axis_code <- ""
    }
    
    
    
    
    
    
    ########## 3.3.11 Color-Palette - Fill ##########
    if (input$Color_Palette != "Gemäss Theme" && (input$color_palette_target == "Füllung" | input$color_palette_target == "Füllung und Linien")) {
      # If manual color palette should be created
      if (palette_selected == "Eigene Farbpalette erstellen") {
        # Check if there is at least one value entered
        if (length(manual_colors$values)>0){
          if (length(manual_colors$values)<length(unique(data()[[group_var]]))){
            # Add values
            r_code <- paste0(r_code, sprintf(" +\n  scale_fill_manual(values = rep(c(%s), length(unique(df$%s))))",
                                             paste0(sprintf("'%s'", manual_colors$values), collapse = ", "),
                                             group_var))
            }
          else{
          # Add values
          r_code <- paste0(r_code, sprintf(" +\n  scale_fill_manual(values = c(%s))",
                                           paste0(sprintf("'%s'", manual_colors$values), collapse = ", ")))
          }
        }
      } else {
      r_code <- paste0(r_code, sprintf(" +\n  %s",
                                      switch(palette_selected,
                                             "Accent" = "scale_fill_brewer(palette = 'Accent')",
                                             "Blues" = "scale_fill_brewer(palette = 'Blues')",
                                             "Greens" = "scale_fill_brewer(palette = 'Greens')",
                                             "Greys" = "scale_fill_brewer(palette = 'Greys')",
                                             "Oranges" = "scale_fill_brewer(palette = 'Oranges')",
                                             "Paired" = "scale_fill_brewer(palette = 'Paired')",
                                             "Pastel1" = "scale_fill_brewer(palette = 'Pastel1')",
                                             "Pastel2" = "scale_fill_brewer(palette = 'Pastel2')",
                                             "Purples" = "scale_fill_brewer(palette = 'Purples')",
                                             "Reds" = "scale_fill_brewer(palette = 'Reds')",
                                             "Set1" = "scale_fill_brewer(palette = 'Set1')",
                                             "Set2" = "scale_fill_brewer(palette = 'Set2')",
                                             "Set3" = "scale_fill_brewer(palette = 'Set3')",
                                             "Spectral" = "scale_fill_brewer(palette = 'Spectral')",
                                             "grey" = "scale_fill_grey()",
                                             "hue" = "scale_fill_hue()",
                                             "ordinal" = "scale_fill_ordinal()",
                                             "viridis" = "scale_fill_viridis_d(option = 'viridis')",
                                             "viridis - magma" = "scale_fill_viridis_d(option = 'magma')",
                                             "viridis - plasma" = "scale_fill_viridis_d(option = 'plasma')",
                                             "viridis - inferno" = "scale_fill_viridis_d(option = 'inferno')",
                                             "viridis - cividis" = "scale_fill_viridis_d(option = 'cividis')",
                                             "viridis - mako" = "scale_fill_viridis_d(option = 'mako')",
                                             "viridis - rocket" = "scale_fill_viridis_d(option = 'rocket')",
                                             "viridis - turbo" = "scale_fill_viridis_d(option = 'turbo')",
                                             "aas" = "scale_fill_aaas()",
                                             "bmj" = "scale_fill_bmj()",
                                             "cosmic" = "scale_fill_cosmic()",
                                             "d3" = "scale_fill_d3()",
                                             "flatui" = "scale_fill_flatui()",
                                             "frontiers" = "scale_fill_frontiers()",
                                             "futurama" = "scale_fill_futurama()",
                                             "igv" = "scale_fill_igv()",
                                             "jama" = "scale_fill_jama()",
                                             "lancet" = "scale_fill_lancet()",
                                             "locuszoom" = "scale_fill_locuszoom()",
                                             "nejm" = "scale_fill_nejm()",
                                             "npg" = "scale_fill_npg()",
                                             "observable" = "scale_fill_observable()",
                                             "rickandmorty" = "scale_fill_rickandmorty()",
                                             "simpsons" = "scale_fill_simpsons()",
                                             "startrek" = "scale_fill_startrek()",
                                             "tron" = "scale_fill_tron()",
                                             "uchicago" = "scale_fill_uchicago()",
                                             "ucscgb" = "scale_fill_ucscgb()",
                                             "jco" = "scale_fill_jco()",
                                             "calc" = "scale_fill_calc()",
                                             "canva" = "scale_fill_canva()",
                                             "colorblind" = "scale_fill_colorblind()",
                                             "economist" = "scale_fill_economist()",
                                             "excel" = "scale_fill_excel()",
                                             "excel_new" = "scale_fill_excel_new()",
                                             "few" = "scale_fill_few()",
                                             "fivethirtyeight" = "scale_fill_fivethirtyeight()",
                                             "gdocs" = "scale_fill_gdocs()",
                                             "hc" = "scale_fill_hc()",
                                             "pander" = "scale_fill_pander()",
                                             "ptol" = "scale_fill_ptol()",
                                             "solarized" = "scale_fill_solarized()",
                                             "stata" = "scale_fill_stata()",
                                             "tableau" = "scale_fill_tableau()",
                                             "wsj" = "scale_fill_wsj()"
                                             )
                                      )
                      )}
    }
    
    
    
    
    
    
    ########## 3.3.11 Color-Palette - color ##########
    if (input$Color_Palette != "Gemäss Theme" && (input$color_palette_target == "Linien" | input$color_palette_target == "Füllung und Linien")) {
      # If manual color palette should be created
      if (palette_selected == "Eigene Farbpalette erstellen") {
        # Check if there is at least one value entered
        if (length(manual_colors$values)>0){
          if (length(manual_colors$values)<length(unique(data()[[group_var]]))){
            # Add values
            r_code <- paste0(r_code, sprintf(" +\n  scale_color_manual(values = rep(c(%s), length(unique(df$%s))))",
                                             paste0(sprintf("'%s'", manual_colors$values), collapse = ", "),
                                             group_var))
          }
          else{
            # Add values
            r_code <- paste0(r_code, sprintf(" +\n  scale_color_manual(values = c(%s))",
                                             paste0(sprintf("'%s'", manual_colors$values), collapse = ", ")))
          }
        }
      } else {
        r_code <- paste0(r_code, sprintf(" +\n  %s",
                                         switch(palette_selected,
                                                "Accent" = "scale_color_brewer(palette = 'Accent')",
                                                "Blues" = "scale_color_brewer(palette = 'Blues')",
                                                "Greens" = "scale_color_brewer(palette = 'Greens')",
                                                "Greys" = "scale_color_brewer(palette = 'Greys')",
                                                "Oranges" = "scale_color_brewer(palette = 'Oranges')",
                                                "Paired" = "scale_color_brewer(palette = 'Paired')",
                                                "Pastel1" = "scale_color_brewer(palette = 'Pastel1')",
                                                "Pastel2" = "scale_color_brewer(palette = 'Pastel2')",
                                                "Purples" = "scale_color_brewer(palette = 'Purples')",
                                                "Reds" = "scale_color_brewer(palette = 'Reds')",
                                                "Set1" = "scale_color_brewer(palette = 'Set1')",
                                                "Set2" = "scale_color_brewer(palette = 'Set2')",
                                                "Set3" = "scale_color_brewer(palette = 'Set3')",
                                                "Spectral" = "scale_color_brewer(palette = 'Spectral')",
                                                "grey" = "scale_color_grey()",
                                                "hue" = "scale_color_hue()",
                                                "ordinal" = "scale_color_ordinal()",
                                                "viridis" = "scale_color_viridis_d(option = 'viridis')",
                                                "viridis - magma" = "scale_color_viridis_d(option = 'magma')",
                                                "viridis - plasma" = "scale_color_viridis_d(option = 'plasma')",
                                                "viridis - inferno" = "scale_color_viridis_d(option = 'inferno')",
                                                "viridis - cividis" = "scale_color_viridis_d(option = 'cividis')",
                                                "viridis - mako" = "scale_color_viridis_d(option = 'mako')",
                                                "viridis - rocket" = "scale_color_viridis_d(option = 'rocket')",
                                                "viridis - turbo" = "scale_color_viridis_d(option = 'turbo')",
                                                "aas" = "scale_color_aaas()",
                                                "bmj" = "scale_color_bmj()",
                                                "cosmic" = "scale_color_cosmic()",
                                                "d3" = "scale_color_d3()",
                                                "flatui" = "scale_color_flatui()",
                                                "frontiers" = "scale_color_frontiers()",
                                                "futurama" = "scale_color_futurama()",
                                                "igv" = "scale_color_igv()",
                                                "jama" = "scale_color_jama()",
                                                "lancet" = "scale_color_lancet()",
                                                "locuszoom" = "scale_color_locuszoom()",
                                                "nejm" = "scale_color_nejm()",
                                                "npg" = "scale_color_npg()",
                                                "observable" = "scale_color_observable()",
                                                "rickandmorty" = "scale_color_rickandmorty()",
                                                "simpsons" = "scale_color_simpsons()",
                                                "startrek" = "scale_color_startrek()",
                                                "tron" = "scale_color_tron()",
                                                "uchicago" = "scale_color_uchicago()",
                                                "ucscgb" = "scale_color_ucscgb()",
                                                "jco" = "scale_color_jco()",
                                                "calc" = "scale_color_calc()",
                                                "canva" = "scale_color_canva()",
                                                "colorblind" = "scale_color_colorblind()",
                                                "economist" = "scale_color_economist()",
                                                "excel" = "scale_color_excel()",
                                                "excel_new" = "scale_color_excel_new()",
                                                "few" = "scale_color_few()",
                                                "fivethirtyeight" = "scale_color_fivethirtyeight()",
                                                "gdocs" = "scale_color_gdocs()",
                                                "hc" = "scale_color_hc()",
                                                "pander" = "scale_color_pander()",
                                                "ptol" = "scale_color_ptol()",
                                                "solarized" = "scale_color_solarized()",
                                                "stata" = "scale_color_stata()",
                                                "tableau" = "scale_color_tableau()",
                                                "wsj" = "scale_color_wsj()"
                                         )
        )
        )}
    }    


    
    
    
    
    ############### 3.4 Generate Theme-Code ###############
    # Create Variable for Theme Code
    theme_code <- ""
    
    
    
    
    
    ########## 3.4.1 Title ##########
    if (input$Title_Font != "Gemäss Theme" || input$Title_Face != "Gemäss Theme" ||
        input$Title_Color != "" || !is.na(input$Title_Size) || input$Title_Alignment != "Gemäss Theme") {
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "plot.title = element_text(")
      
      
      theme_code <- paste0(theme_code,
                           if (input$Title_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                           switch(input$Title_Font,
                                                                                  "Sans Serife" = "sans",
                                                                                  "Serife" = "serif",
                                                                                  "Monospace" = "mono")) else "",
                           if (input$Title_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                           switch(input$Title_Face,
                                                                                  "Normal" = "plain",
                                                                                  "Fett" = "bold",
                                                                                  "Kursiv" = "italic",
                                                                                  "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Title_Size)) sprintf("size = %.1f, ", input$Title_Size) else "",
                           if (input$Title_Color != "") sprintf("colour = '%s', ", input$Title_Color) else "",
                           if (input$Title_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                switch(input$Title_Alignment,
                                                                                       "Linksbündig" = 0,
                                                                                       "Mittig" = 0.5,
                                                                                       "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.2 Subtitle ##########
    if (input$Subtitle_Font != "Gemäss Theme" || input$Subtitle_Face != "Gemäss Theme" ||
        input$Subtitle_Color != "" || !is.na(input$Subtitle_Size) || input$Subtitle_Alignment != "Gemäss Theme") {
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "plot.subtitle = element_text(")
      
      theme_code <- paste0(theme_code,
                           if (input$Subtitle_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                              switch(input$Subtitle_Font,
                                                                                     "Sans Serife" = "sans",
                                                                                     "Serife" = "serif",
                                                                                     "Monospace" = "mono")) else "",
                           if (input$Subtitle_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                              switch(input$Subtitle_Face,
                                                                                     "Normal" = "plain",
                                                                                     "Fett" = "bold",
                                                                                     "Kursiv" = "italic",
                                                                                     "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Subtitle_Size)) sprintf("size = %.1f, ", input$Subtitle_Size) else "",
                           if (input$Subtitle_Color != "") sprintf("colour = '%s', ", input$Subtitle_Color) else "",
                           if (input$Subtitle_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                   switch(input$Subtitle_Alignment,
                                                                                          "Linksbündig" = 0,
                                                                                          "Mittig" = 0.5,
                                                                                          "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.3 X-Axis Title ##########
    if (input$X_Axis_Title_Font != "Gemäss Theme" || input$X_Axis_Title_Face != "Gemäss Theme" ||
        input$X_Axis_Title_Color != "" || !is.na(input$X_Axis_Title_Size) || input$X_Axis_Title_Alignment != "Gemäss Theme") {
      
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "axis.title.x = element_text(")
      
      theme_code <- paste0(theme_code,
                           if (input$X_Axis_Title_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                                  switch(input$X_Axis_Title_Font,
                                                                                         "Sans Serife" = "sans",
                                                                                         "Serife" = "serif",
                                                                                         "Monospace" = "mono")) else "",
                           if (input$X_Axis_Title_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                                  switch(input$X_Axis_Title_Face,
                                                                                         "Normal" = "plain",
                                                                                         "Fett" = "bold",
                                                                                         "Kursiv" = "italic",
                                                                                         "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$X_Axis_Title_Size)) sprintf("size = %.1f, ", input$X_Axis_Title_Size) else "",
                           if (input$X_Axis_Title_Color != "") sprintf("colour = '%s', ", input$X_Axis_Title_Color) else "",
                           if (input$X_Axis_Title_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                       switch(input$X_Axis_Title_Alignment,
                                                                                              "Linksbündig" = 0,
                                                                                              "Mittig" = 0.5,
                                                                                              "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.4 Y-Axis Title ##########
    if (input$Y_Axis_Title_Font != "Gemäss Theme" || input$Y_Axis_Title_Face != "Gemäss Theme" ||
        input$Y_Axis_Title_Color != "" || !is.na(input$Y_Axis_Title_Size) || input$Y_Axis_Title_Alignment != "Gemäss Theme") {
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "axis.title.y = element_text(")
      
      theme_code <- paste0(theme_code,
                           if (input$Y_Axis_Title_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                                  switch(input$Y_Axis_Title_Font,
                                                                                         "Sans Serife" = "sans",
                                                                                         "Serife" = "serif",
                                                                                         "Monospace" = "mono")) else "",
                           if (input$Y_Axis_Title_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                                  switch(input$Y_Axis_Title_Face,
                                                                                         "Normal" = "plain",
                                                                                         "Fett" = "bold",
                                                                                         "Kursiv" = "italic",
                                                                                         "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Y_Axis_Title_Size)) sprintf("size = %.1f, ", input$Y_Axis_Title_Size) else "",
                           if (input$Y_Axis_Title_Color != "") sprintf("colour = '%s', ", input$Y_Axis_Title_Color) else "",
                           if (input$Y_Axis_Title_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                       switch(input$Y_Axis_Title_Alignment,
                                                                                              "Linksbündig" = 0,
                                                                                              "Mittig" = 0.5,
                                                                                              "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.5 X-Axis-Labels ##########
    if (input$Axis_X_Text_Font != "Gemäss Theme" || input$Axis_X_Text_Face != "Gemäss Theme" ||
        input$Axis_X_Text_Color != "" || !is.na(input$Axis_X_Text_Size) || input$Axis_X_Text_H_Alignment != "Gemäss Theme"
        || input$Axis_X_Text_V_Alignment != "Gemäss Theme" || !is.na(input$Axis_X_Text_Rotation)) {
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      
      
      theme_code <- paste0(theme_code, "axis.text.x = element_text(")
      
      
      theme_code <- paste0(theme_code,
                           if (input$Axis_X_Text_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                                 switch(input$Axis_X_Text_Font,
                                                                                        "Sans Serife" = "sans",
                                                                                        "Serife" = "serif",
                                                                                        "Monospace" = "mono")) else "",
                           if (input$Axis_X_Text_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                                 switch(input$Axis_X_Text_Face,
                                                                                        "Normal" = "plain",
                                                                                        "Fett" = "bold",
                                                                                        "Kursiv" = "italic",
                                                                                        "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Axis_X_Text_Size)) sprintf("size = %.1f, ", input$Axis_X_Text_Size) else "",
                           if (input$Axis_X_Text_Color != "") sprintf("colour = '%s', ", input$Axis_X_Text_Color) else "",
                           if (input$Axis_X_Text_H_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                        switch(input$Axis_X_Text_H_Alignment,
                                                                                               "Linksbündig" = 0,
                                                                                               "Mittig" = 0.5,
                                                                                               "Rechtsbündig" = 1)) else "",
                           if (input$Axis_X_Text_V_Alignment != "Gemäss Theme") sprintf("vjust = %s, ", 
                                                                                        switch(input$Axis_X_Text_V_Alignment,
                                                                                               "Unten" = 0,
                                                                                               "Mittig" = 0.5,
                                                                                               "Oben" = 1)) else "",
                           if (!is.na(input$Axis_X_Text_Rotation)) sprintf("angle = %.0f, ", input$Axis_X_Text_Rotation) else ""
      )
      
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.6 Y-Axis-Labels ##########
    if (input$Axis_Y_Text_Font != "Gemäss Theme" || input$Axis_Y_Text_Face != "Gemäss Theme" ||
        input$Axis_Y_Text_Color != "" || !is.na(input$Axis_Y_Text_Size) || input$Axis_Y_Text_H_Alignment != "Gemäss Theme"
        || input$Axis_Y_Text_V_Alignment != "Gemäss Theme" || !is.na(input$Axis_Y_Text_Rotation)) {
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      
      
      theme_code <- paste0(theme_code, "axis.text.y = element_text(")
      
      
      theme_code <- paste0(theme_code,
                           if (input$Axis_Y_Text_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                                 switch(input$Axis_Y_Text_Font,
                                                                                        "Sans Serife" = "sans",
                                                                                        "Serife" = "serif",
                                                                                        "Monospace" = "mono")) else "",
                           if (input$Axis_Y_Text_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                                 switch(input$Axis_Y_Text_Face,
                                                                                        "Normal" = "plain",
                                                                                        "Fett" = "bold",
                                                                                        "Kursiv" = "italic",
                                                                                        "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Axis_Y_Text_Size)) sprintf("size = %.1f, ", input$Axis_Y_Text_Size) else "",
                           if (input$Axis_Y_Text_Color != "") sprintf("colour = '%s', ", input$Axis_Y_Text_Color) else "",
                           if (input$Axis_Y_Text_H_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                        switch(input$Axis_Y_Text_H_Alignment,
                                                                                               "Linksbündig" = 0,
                                                                                               "Mittig" = 0.5,
                                                                                               "Rechtsbündig" = 1)) else "",
                           if (input$Axis_Y_Text_V_Alignment != "Gemäss Theme") sprintf("vjust = %s, ", 
                                                                                        switch(input$Axis_Y_Text_V_Alignment,
                                                                                               "Unten" = 0,
                                                                                               "Mittig" = 0.5,
                                                                                               "Oben" = 1)) else "",
                           if (!is.na(input$Axis_Y_Text_Rotation)) sprintf("angle = %.0f, ", input$Axis_Y_Text_Rotation) else ""
      )
      
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.7 X Axis Lines ##########
    if (input$Axis_X_Linetype != "Gemäss Theme" || !is.na(input$Axis_X_Size) || input$Axis_X_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      if (input$Axis_X_Linetype == "Keine"){
        theme_code <- paste0(theme_code, "axis.line.x = element_blank(")
      } else {
      theme_code <- paste0(theme_code, "axis.line.x = element_line(")

      theme_code <- paste0(theme_code,
                           if (input$Axis_X_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                switch(input$Axis_X_Linetype,
                                                                                       "Solide" = "solid",
                                                                                       "Gestrichelt" = "dashed",
                                                                                       "Gepunkted" = "dotted",
                                                                                       "Punktgestrichelt" = "dotdash",
                                                                                       "Langgestrichen" = "longdash",
                                                                                       "Doppelt gestrichelt" = "twodash"
                                                                                       )) else "",
                           if (!is.na(input$Axis_X_Size)) sprintf("size = %.1f, ", input$Axis_X_Size) else "",
                           if (input$Axis_X_Color != "") sprintf("colour = '%s', ", input$Axis_X_Color) else ""
                           )
      }


      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }




    ########## 3.4.8 Y Axis Lines ##########
    if (input$Axis_Y_Linetype != "Gemäss Theme" || !is.na(input$Axis_Y_Size) || input$Axis_Y_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      if (input$Axis_Y_Linetype == "Keine"){
        theme_code <- paste0(theme_code, "axis.line.y = element_blank(")
      } else {
        theme_code <- paste0(theme_code, "axis.line.y = element_line(")

        theme_code <- paste0(theme_code,
                             if (input$Axis_Y_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                  switch(input$Axis_Y_Linetype,
                                                                                         "Solide" = "solid",
                                                                                         "Gestrichelt" = "dashed",
                                                                                         "Gepunkted" = "dotted",
                                                                                         "Punktgestrichelt" = "dotdash",
                                                                                         "Langgestrichen" = "longdash",
                                                                                         "Doppelt gestrichelt" = "twodash"
                                                                                  )) else "",
                             if (!is.na(input$Axis_Y_Size)) sprintf("size = %.1f, ", input$Axis_Y_Size) else "",
                             if (input$Axis_Y_Color != "") sprintf("colour = '%s', ", input$Axis_Y_Color) else ""
        )
      }


      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    ########## 3.4.9 X Axis Ticks ##########
    if (!is.na(input$Axis_X_Ticks_Length)) {
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("axis.ticks.length.x = unit('%.1f', 'pt')", input$Axis_X_Ticks_Length))
    }

    if (input$Axis_X_Ticks_Linetype != "Gemäss Theme" || !is.na(input$Axis_X_Ticks_Size) || input$Axis_X_Ticks_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, "axis.ticks.x = element_line(")

      theme_code <- paste0(theme_code,
                           if (input$Axis_X_Ticks_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                switch(input$Axis_X_Ticks_Linetype,
                                                                                       "Solide" = "solid",
                                                                                       "Gestrichelt" = "dashed",
                                                                                       "Gepunkted" = "dotted",
                                                                                       "Punktgestrichelt" = "dotdash",
                                                                                       "Langgestrichen" = "longdash",
                                                                                       "Doppelt gestrichelt" = "twodash"
                                                                                )) else "",
                           if (!is.na(input$Axis_X_Ticks_Size)) sprintf("size = %.1f, ", input$Axis_X_Ticks_Size) else "",
                           if (input$Axis_X_Ticks_Color != "") sprintf("colour = '%s', ", input$Axis_X_Ticks_Color) else ""
      )

      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }




    ########## 3.4.10 Y Axis Ticks ##########
    if (!is.na(input$Axis_Y_Ticks_Length)) {
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("axis.ticks.length.y = unit('%.1f', 'pt')", input$Axis_Y_Ticks_Length))
    }


    if (input$Axis_Y_Ticks_Linetype != "Gemäss Theme" || !is.na(input$Axis_Y_Ticks_Size) || input$Axis_Y_Ticks_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, "axis.ticks.y = element_line(")

      theme_code <- paste0(theme_code,
                           if (input$Axis_Y_Ticks_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                      switch(input$Axis_Y_Ticks_Linetype,
                                                                                             "Solide" = "solid",
                                                                                             "Gestrichelt" = "dashed",
                                                                                             "Gepunkted" = "dotted",
                                                                                             "Punktgestrichelt" = "dotdash",
                                                                                             "Langgestrichen" = "longdash",
                                                                                             "Doppelt gestrichelt" = "twodash"
                                                                                      )) else "",
                           if (!is.na(input$Axis_Y_Ticks_Size)) sprintf("size = %.1f, ", input$Axis_Y_Ticks_Size) else "",
                           if (input$Axis_Y_Ticks_Color != "") sprintf("colour = '%s', ", input$Axis_Y_Ticks_Color) else ""
      )


      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.11 Major Gridlines X ##########
    if (input$Major_Grid_X_Linetype != "Gemäss Theme" || !is.na(input$Major_Grid_X_Size) || input$Major_Grid_X_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      if (input$Major_Grid_X_Linetype == "Keine"){
        theme_code <- paste0(theme_code, "panel.grid.major.x = element_blank(")
      } else {
        theme_code <- paste0(theme_code, "panel.grid.major.x = element_line(")
        
        theme_code <- paste0(theme_code,
                             if (input$Major_Grid_X_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                  switch(input$Major_Grid_X_Linetype,
                                                                                         "Solide" = "solid", 
                                                                                         "Gestrichelt" = "dashed", 
                                                                                         "Gepunkted" = "dotted", 
                                                                                         "Punktgestrichelt" = "dotdash", 
                                                                                         "Langgestrichen" = "longdash", 
                                                                                         "Doppelt gestrichelt" = "twodash"
                                                                                  )) else "",
                             if (!is.na(input$Major_Grid_X_Size)) sprintf("size = %.1f, ", input$Major_Grid_X_Size) else "",
                             if (input$Major_Grid_X_Color != "") sprintf("colour = '%s', ", input$Major_Grid_X_Color) else ""
        )
      }
      
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.12 Major Gridlines Y ##########
    if (input$Major_Grid_Y_Linetype != "Gemäss Theme" || !is.na(input$Major_Grid_Y_Size) || input$Major_Grid_Y_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      if (input$Major_Grid_Y_Linetype == "Keine"){
        theme_code <- paste0(theme_code, "panel.grid.major.y = element_blank(")
      } else {
        theme_code <- paste0(theme_code, "panel.grid.major.y = element_line(")
        
        theme_code <- paste0(theme_code,
                             if (input$Major_Grid_Y_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                        switch(input$Major_Grid_Y_Linetype,
                                                                                               "Solide" = "solid", 
                                                                                               "Gestrichelt" = "dashed", 
                                                                                               "Gepunkted" = "dotted", 
                                                                                               "Punktgestrichelt" = "dotdash", 
                                                                                               "Langgestrichen" = "longdash", 
                                                                                               "Doppelt gestrichelt" = "twodash"
                                                                                        )) else "",
                             if (!is.na(input$Major_Grid_Y_Size)) sprintf("size = %.1f, ", input$Major_Grid_Y_Size) else "",
                             if (input$Major_Grid_Y_Color != "") sprintf("colour = '%s', ", input$Major_Grid_Y_Color) else ""
        )
      }
      
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.13 Minor Gridlines X ##########
    if (input$Minor_Grid_X_Linetype != "Gemäss Theme" || !is.na(input$Minor_Grid_X_Size) || input$Minor_Grid_X_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      if (input$Minor_Grid_X_Linetype == "Keine"){
        theme_code <- paste0(theme_code, "panel.grid.minor.x = element_blank(")
      } else {
        theme_code <- paste0(theme_code, "panel.grid.minor.x = element_line(")
        
        theme_code <- paste0(theme_code,
                             if (input$Minor_Grid_X_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                        switch(input$Minor_Grid_X_Linetype,
                                                                                               "Solide" = "solid", 
                                                                                               "Gestrichelt" = "dashed", 
                                                                                               "Gepunkted" = "dotted", 
                                                                                               "Punktgestrichelt" = "dotdash", 
                                                                                               "Langgestrichen" = "longdash", 
                                                                                               "Doppelt gestrichelt" = "twodash"
                                                                                        )) else "",
                             if (!is.na(input$Minor_Grid_X_Size)) sprintf("size = %.1f, ", input$Minor_Grid_X_Size) else "",
                             if (input$Minor_Grid_X_Color != "") sprintf("colour = '%s', ", input$Minor_Grid_X_Color) else ""
        )
      }
      
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    ########## 3.4.14 Minor Gridlines Y ##########
    if (input$Minor_Grid_Y_Linetype != "Gemäss Theme" || !is.na(input$Minor_Grid_Y_Size) || input$Minor_Grid_Y_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      if (input$Minor_Grid_Y_Linetype == "Keine"){
        theme_code <- paste0(theme_code, "panel.grid.minor.y = element_blank(")
      } else {
        theme_code <- paste0(theme_code, "panel.grid.minor.y = element_line(")
        
        theme_code <- paste0(theme_code,
                             if (input$Minor_Grid_Y_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                        switch(input$Minor_Grid_Y_Linetype,
                                                                                               "Solide" = "solid", 
                                                                                               "Gestrichelt" = "dashed", 
                                                                                               "Gepunkted" = "dotted", 
                                                                                               "Punktgestrichelt" = "dotdash", 
                                                                                               "Langgestrichen" = "longdash", 
                                                                                               "Doppelt gestrichelt" = "twodash"
                                                                                        )) else "",
                             if (!is.na(input$Minor_Grid_Y_Size)) sprintf("size = %.1f, ", input$Minor_Grid_Y_Size) else "",
                             if (input$Minor_Grid_Y_Color != "") sprintf("colour = '%s', ", input$Minor_Grid_Y_Color) else ""
        )
      }
      
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.15 Plot Background ##########
    if (input$Plot_Background_Color != "" || input$Plot_Background_Linetype != "Gemäss Theme" 
        || !is.na(input$Plot_Background_Size) || input$Plot_Background_Line_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, "plot.background = element_rect(")
      
      theme_code <- paste0(theme_code,
                           if (input$Plot_Background_Color != "") sprintf("fill = '%s', ", input$Plot_Background_Color) else "",
                           if (input$Plot_Background_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                      switch(input$Plot_Background_Linetype,
                                                                                             "Solide" = "solid", 
                                                                                             "Gestrichelt" = "dashed", 
                                                                                             "Gepunkted" = "dotted", 
                                                                                             "Punktgestrichelt" = "dotdash", 
                                                                                             "Langgestrichen" = "longdash", 
                                                                                             "Doppelt gestrichelt" = "twodash"
                                                                                      )) else "",
                           if (!is.na(input$Plot_Background_Size)) sprintf("linewidth = %.1f, ", input$Plot_Background_Size) else "",
                           if (input$Plot_Background_Line_Color != "") sprintf("colour = '%s', ", input$Plot_Background_Line_Color) else ""
      )
      
      # Remove trailing comma and close the element-function
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.16 Plot Background ##########
    if (input$Panel_Background_Color != "" || input$Panel_Background_Linetype != "Gemäss Theme" 
        || !is.na(input$Panel_Background_Size) || input$Panel_Background_Line_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, "panel.background = element_rect(")
      
      theme_code <- paste0(theme_code,
                           if (input$Panel_Background_Color != "") sprintf("fill = '%s', ", input$Panel_Background_Color) else "",
                           if (input$Panel_Background_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                         switch(input$Panel_Background_Linetype,
                                                                                                "Solide" = "solid", 
                                                                                                "Gestrichelt" = "dashed", 
                                                                                                "Gepunkted" = "dotted", 
                                                                                                "Punktgestrichelt" = "dotdash", 
                                                                                                "Langgestrichen" = "longdash", 
                                                                                                "Doppelt gestrichelt" = "twodash"
                                                                                         )) else "",
                           if (!is.na(input$Panel_Background_Size)) sprintf("linewidth = %.1f, ", input$Panel_Background_Size) else "",
                           if (input$Panel_Background_Line_Color != "") sprintf("colour = '%s', ", input$Panel_Background_Line_Color) else ""
      )
      
      # Remove trailing comma and close the element-function
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    
    ########## 3.4.17 Legend-Title ##########
    if (input$Legend_Title_Font != "Gemäss Theme" || input$Legend_Title_Face != "Gemäss Theme" ||
        input$Legend_Title_Color != "" || !is.na(input$Legend_Title_Size) || input$Legend_Title_Alignment != "Gemäss Theme") {
      
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "legend.title = element_text(")
      
      
      theme_code <- paste0(theme_code,
                           if (input$Legend_Title_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                                  switch(input$Legend_Title_Font,
                                                                                         "Sans Serife" = "sans",
                                                                                         "Serife" = "serif",
                                                                                         "Monospace" = "mono")) else "",
                           if (input$Legend_Title_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                                  switch(input$Legend_Title_Face,
                                                                                         "Normal" = "plain",
                                                                                         "Fett" = "bold",
                                                                                         "Kursiv" = "italic",
                                                                                         "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Legend_Title_Size)) sprintf("size = %.1f, ", input$Legend_Title_Size) else "",
                           if (input$Legend_Title_Color != "") sprintf("colour = '%s', ", input$Legend_Title_Color) else "",
                           if (input$Legend_Title_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                       switch(input$Legend_Title_Alignment,
                                                                                              "Linksbündig" = 0,
                                                                                              "Mittig" = 0.5,
                                                                                              "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.18 Legend-Text ##########
    if (input$Legend_Text_Font != "Gemäss Theme" || input$Legend_Text_Face != "Gemäss Theme" ||
        input$Legend_Text_Color != "" || !is.na(input$Legend_Text_Size) || input$Legend_Text_Alignment != "Gemäss Theme") {
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "legend.text = element_text(")
      
      
      theme_code <- paste0(theme_code,
                           if (input$Legend_Text_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                                 switch(input$Legend_Text_Font,
                                                                                        "Sans Serife" = "sans",
                                                                                        "Serife" = "serif",
                                                                                        "Monospace" = "mono")) else "",
                           if (input$Legend_Text_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                                 switch(input$Legend_Text_Face,
                                                                                        "Normal" = "plain",
                                                                                        "Fett" = "bold",
                                                                                        "Kursiv" = "italic",
                                                                                        "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Legend_Text_Size)) sprintf("size = %.1f, ", input$Legend_Text_Size) else "",
                           if (input$Legend_Text_Color != "") sprintf("colour = '%s', ", input$Legend_Text_Color) else "",
                           if (input$Legend_Text_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                      switch(input$Legend_Text_Alignment,
                                                                                             "Linksbündig" = 0,
                                                                                             "Mittig" = 0.5,
                                                                                             "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.19 Legend Background ##########
    if (input$Plot_Background_Color != "" || input$Plot_Background_Linetype != "Gemäss Theme" 
        || !is.na(input$Plot_Background_Size) || input$Plot_Background_Line_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, "legend.background = element_rect(")
      
      theme_code <- paste0(theme_code,
                           if (input$Plot_Background_Color != "") sprintf("colour = '%s', ", input$Plot_Background_Color) else "",
                           if (input$Plot_Background_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                         switch(input$Plot_Background_Linetype,
                                                                                                "Solide" = "solid", 
                                                                                                "Gestrichelt" = "dashed", 
                                                                                                "Gepunkted" = "dotted", 
                                                                                                "Punktgestrichelt" = "dotdash", 
                                                                                                "Langgestrichen" = "longdash", 
                                                                                                "Doppelt gestrichelt" = "twodash"
                                                                                         )) else "",
                           if (!is.na(input$Plot_Background_Size)) sprintf("linewidth = %.1f, ", input$Plot_Background_Size) else "",
                           if (input$Plot_Background_Line_Color != "") sprintf("colour = '%s', ", input$Plot_Background_Line_Color) else ""
      )
      
      # Remove trailing comma and close the element-function
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.20 Legend Options ##########
    if (input$Legend_Position != "Gemäss Theme"){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.position = '%s', ",
                                                                     switch(input$Legend_Position,
                                                                            "Keine" = "none", 
                                                                            "Rechts" = "right", 
                                                                            "Unten" = "bottom", 
                                                                            "Links" = "left", 
                                                                            "Oben" = "top", 
                                                                            "Im Plot" = "inside", ")"
                                                                     )))
    }
    
    if (input$Legend_Title_Position != "Gemäss Theme"){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.title.position = '%s', ",
                                               switch(input$Legend_Title_Position,
                                                      "Oben" = "top", 
                                                      "Rechts" = "right", 
                                                      "Unten" = "bottom", 
                                                      "Links" = "left", ")"
                                               )))
    }
    
    if (input$Legend_Text_Position != "Gemäss Theme"){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.text.position = '%s', ",
                                               switch(input$Legend_Text_Position,
                                                      "Oben" = "top", 
                                                      "Rechts" = "right", 
                                                      "Unten" = "bottom", 
                                                      "Links" = "left", ")"
                                               )))
    }
    
    if (input$Legend_Text_Direktion != "Gemäss Theme"){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.direction = '%s', ",
                                               switch(input$Legend_Text_Direktion,
                                                      "Vertikal" = "vertical",
                                                      "Horizontal" = "horizontal", ")"
                                               )))
    }
    
    if (!is.na(input$Legend_Key_Width)){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.key.width = unit(%.1f, 'pt'", input$Stripe_X_Size))
    }
    
    if (!is.na(input$Legend_Key_Height)){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.key.height = unit(%.1f, 'pt'", input$Stripe_X_Size))
    }
    
    if (!is.na(input$Legend_Key_Spacing)){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.key.spacing = unit(%.1f, 'pt'", input$Legend_Key_Spacing))
    }
    
    if (!is.na(input$Legend_Box_Spacing)){
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, sprintf("legend.box.spacing = unit(%.1f, 'pt'", input$Legend_Box_Spacing))
    }
    
    
    ########## 3.4.21 Facet-Row Background ##########
    if (input$Stripe_X_Color != "" || input$Stripe_X_Linetype != "Gemäss Theme" 
        || !is.na(input$Stripe_X_Size) || input$Stripe_X_Line_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, "strip.background.x = element_rect(")
      
      theme_code <- paste0(theme_code,
                           if (input$Stripe_X_Color != "") sprintf("fill = '%s', ", input$Stripe_X_Color) else "",
                           if (input$Stripe_X_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                         switch(input$Stripe_X_Linetype,
                                                                                                "Solide" = "solid", 
                                                                                                "Gestrichelt" = "dashed", 
                                                                                                "Gepunkted" = "dotted", 
                                                                                                "Punktgestrichelt" = "dotdash", 
                                                                                                "Langgestrichen" = "longdash", 
                                                                                                "Doppelt gestrichelt" = "twodash"
                                                                                         )) else "",
                           if (!is.na(input$Stripe_X_Size)) sprintf("linewidth = %.1f, ", input$Stripe_X_Size) else "",
                           if (input$Stripe_X_Line_Color != "") sprintf("colour = '%s', ", input$Stripe_X_Line_Color) else ""
      )
      
      # Remove trailing comma and close the element-function
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    ########## 3.4.22 Facet-Column Background ##########
    if (input$Stripe_Y_Color != "" || input$Stripe_Y_Linetype != "Gemäss Theme" 
        || !is.na(input$Stripe_Y_Size) || input$Stripe_Y_Line_Color != "") {
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      theme_code <- paste0(theme_code, "strip.background.y = element_rect(")
      
      theme_code <- paste0(theme_code,
                           if (input$Stripe_Y_Color != "") sprintf("fill = '%s', ", input$Stripe_Y_Color) else "",
                           if (input$Stripe_Y_Linetype != "Gemäss Theme") sprintf("linetype = '%s', ",
                                                                                  switch(input$Stripe_Y_Linetype,
                                                                                         "Solide" = "solid", 
                                                                                         "Gestrichelt" = "dashed", 
                                                                                         "Gepunkted" = "dotted", 
                                                                                         "Punktgestrichelt" = "dotdash", 
                                                                                         "Langgestrichen" = "longdash", 
                                                                                         "Doppelt gestrichelt" = "twodash"
                                                                                  )) else "",
                           if (!is.na(input$Stripe_Y_Size)) sprintf("linewidth = %.1f, ", input$Stripe_Y_Size) else "",
                           if (input$Stripe_Y_Line_Color != "") sprintf("colour = '%s', ", input$Stripe_Y_Line_Color) else ""
      )
      
      # Remove trailing comma and close the element-function
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }    
    
    
    
    
    ########## 3.4.23 Facet-Row Text ##########
    if (input$Stripe_X_Font != "Gemäss Theme" || input$Stripe_X_Face != "Gemäss Theme" ||
        input$Stripe_X_Color != "" || !is.na(input$Stripe_X_Size) || input$Stripe_X_Alignment != "Gemäss Theme") {
      
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "strip.text.x = element_text(")
      
      theme_code <- paste0(theme_code,
                           if (input$Stripe_X_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                                  switch(input$Stripe_X_Font,
                                                                                         "Sans Serife" = "sans",
                                                                                         "Serife" = "serif",
                                                                                         "Monospace" = "mono")) else "",
                           if (input$Stripe_X_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                                  switch(input$Stripe_X_Face,
                                                                                         "Normal" = "plain",
                                                                                         "Fett" = "bold",
                                                                                         "Kursiv" = "italic",
                                                                                         "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Stripe_X_Size)) sprintf("size = %.1f, ", input$Stripe_X_Size) else "",
                           if (input$Stripe_X_Color != "") sprintf("colour = '%s', ", input$Stripe_X_Color) else "",
                           if (input$Stripe_X_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                       switch(input$Stripe_X_Alignment,
                                                                                              "Linksbündig" = 0,
                                                                                              "Mittig" = 0.5,
                                                                                              "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    ########## 3.4.24 Facet-Column Text ##########
    if (input$Stripe_Y_Font != "Gemäss Theme" || input$Stripe_Y_Face != "Gemäss Theme" ||
        input$Stripe_Y_Color != "" || !is.na(input$Stripe_Y_Size) || input$Stripe_Y_Alignment != "Gemäss Theme") {
      
      
      # Create new Line in Theme-Code if needed
      if (theme_code!=""){
        theme_code <- paste0(theme_code, ",\n  ")
      }
      
      theme_code <- paste0(theme_code, "strip.text.y = element_text(")
      
      theme_code <- paste0(theme_code,
                           if (input$Stripe_Y_Font != "Gemäss Theme") sprintf("family = '%s', ", 
                                                                              switch(input$Stripe_Y_Font,
                                                                                     "Sans Serife" = "sans",
                                                                                     "Serife" = "serif",
                                                                                     "Monospace" = "mono")) else "",
                           if (input$Stripe_Y_Face != "Gemäss Theme") sprintf("face = '%s', ", 
                                                                              switch(input$Stripe_Y_Face,
                                                                                     "Normal" = "plain",
                                                                                     "Fett" = "bold",
                                                                                     "Kursiv" = "italic",
                                                                                     "Fett & Kursiv" = "bold.italic")) else "",
                           if (!is.na(input$Stripe_Y_Size)) sprintf("size = %.1f, ", input$Stripe_Y_Size) else "",
                           if (input$Stripe_Y_Color != "") sprintf("colour = '%s', ", input$Stripe_Y_Color) else "",
                           if (input$Stripe_Y_Alignment != "Gemäss Theme") sprintf("hjust = %s, ", 
                                                                                   switch(input$Stripe_Y_Alignment,
                                                                                          "Linksbündig" = 0,
                                                                                          "Mittig" = 0.5,
                                                                                          "Rechtsbündig" = 1)) else "")
      
      # Remove trailing comma and close `element_text()`
      theme_code <- sub(", $", "", theme_code)
      theme_code <- paste0(theme_code, ")")
    }
    
    
    
    
    
    
    ########## 3.4.20 Adjust Theme C ##########
    if (theme_code!=""){
      theme_code <- paste0(" +\n  theme(", sprintf(theme_code), ")")
      r_code <- paste0(r_code, sprintf(theme_code))
    }
    
    
    
    
    
    
    ########## 3.5 Return R-Code ##########
    r_code
  }
  )  
  
  
  
  
  
  
  
  
  ############### 3.6 Generate Plot ###############
  output$dynamic_plot <- renderUI({
    scaled_width <- input$plot_width_px * (72 / 96) #dpi is 96
    scaled_height <- input$plot_height_px * (72 / 96) #dpi is 96
    
    plotOutput(
      "plot",
      width = paste0(input$plot_width_px, "px"),
      height = paste0(input$plot_height_px, "px")
    )
  })
  
  output$plot <- renderPlot({
    req(data(), r_code())


    df <- data()
    
    if (!is.null(factor_code()) && !identical(factor_code(), "")) {
      eval(parse(text = factor_code()))
    }
    
    
    # Code ausführen und 'q' erstellen
    eval(parse(text = r_code()))
    
    # Den erstellten Plot (nicht den String) zurückgeben
    return(q)
  }, res = 96)
  
  
  
  
  
  
  
  
  ############### 3.7 Execute Code ###############
  # Create reactive full code
  reactive_full_code <- reactive({
    df <- data()
    
    # Require that r_code exists
    req(r_code())
    
    # Define Code-Line for ggplot2
    full_code <- "library(ggplot2)"
    

    # Define Code-Line for ggthemes if needed
    # Check if themes is by ggthemes
    if(input$plot_theme %in% c("Calc", "the Economist", "the Economist White", "Excel", "Few", "FiveThirtyEight", 
                               "Google Docs", "Highcharts JS", "Inversed Gray", "Solarized", "Solarized 2", "Solid", 
                               "Stata", "Tufte", "Wall Street Journal") |
       # Check if color-palette is by ggthemes
       input$Color_Palette %in% c("calc", "canva", "colorblind", 
                                  "economist", "excel", "excel_new", "few", "fivethirtyeight", "gdocs", 
                                  "hc", "pander", "ptol", "solarized", 
                                  "stata", "tableau", "wsj")) {
      # Add line for loading ggthemes
      full_code <- paste0(full_code, "\nlibrary(ggthemes)")
    }
    
    # Define Code-Line for ggsci if needed
    # Check if color-palette is by ggsci
    if(input$Color_Palette %in% c("aas", "bmj", "cosmic", "d3", "flatui", 
                                  "frontiers", "futurama", "igv", "jama", "lancet", "locuszoom", 
                                  "material", "nejm", "npg", "observable", "rickandmorty", "simpsons", "startrek", 
                                  "tron", "uchicago", "ucscgb", "jco")) {
      # Add line for loading ggsci
      full_code <- paste0(full_code, "\nlibrary(ggsci)")
    }
    
    if (!is.null(factor_code()) && !identical(factor_code(), "")) {
      full_code <- paste0(full_code, "\n\n")

      full_code <- paste0(full_code, factor_code())
    }
    
    
    # Add empty lines in code
    full_code <- paste0(full_code, "\n\n", r_code())
    
    # Replace data() with data
    full_code <- gsub("data\\(\\)", "data", full_code)
    
    # Replace aes_string with aes
    # full_code <- gsub("aes_string", "aes", full_code)
    
    # Return full_code
    full_code
  })
  
  
  # Print the reactive r_code
  output$rcode <- renderText({
    reactive_full_code()
  })
  
  
  # Add clipboard buttons
  output$clip <- renderUI({
    rclipButton(
      inputId = "clipbtn",
      label = "",
      clipText = reactive_full_code(), 
      icon = icon("clipboard", class = "fa-3x"),
      placement = "top",
      options = list(delay = list(show = 800, hide = 100), trigger = "hover"),
    )
  })
  
  
  
  
  
  ############### 3.8 Download Plot ###############
  # Function to download Plot
  output$downloadPlot <- downloadHandler(
    filename = function() {
      # Define File-name
      paste("ggpilot-", Sys.Date(), ".", input$file_format, sep = "")
    },
    content = function(file) {
      # Require r_code
      req(r_code())
      # Require that q exists
      req(exists("q"))
      # Create Plot by evaluating r_code
      eval(parse(text = r_code()))

      # Calculate the correct width and height for saving
      width_inch <- input$plot_width_px / 96
      height_inch <- input$plot_height_px / 96
      
      # Save Plot
      ggsave(
        # Save under the defined Name
        filename = file,
        # Get plot (q) and save it
        plot = q,
        # Save in the Calculated Width
        width = width_inch,
        # Save in the Calculated Height
        height = height_inch,
        # DPI is set to 96
        dpi = 96, # DPI is set to 96
        # Save in the requested file format
        device = input$file_format
      )
    }
  )
  
  
  
  
  
  
  
  ############### 3.9 Download Code ###############
  # Function to download r-code
  output$downloadCode <- downloadHandler(
    filename = function() {
      # Define File-name
      paste("ggpilot_code-", Sys.Date(), ".r", sep = "")
    },
    content = function(file) {
      # Save the Code
      code <- reactive_full_code()
      # Write the Code
      writeLines(code, file)
    }
  )    
}




















#################### 4. Run App ####################
shinyApp(ui = ui, server = server)